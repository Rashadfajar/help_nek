<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pusat Bantuan Penyelenggaraan NEK Provinsi DKI Jakarta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ===========================
      Root & Footer
    ============================ */
    :root { --footer-h: 56px; }          /* tinggi footer (desktop/tablet) */
    footer { height: var(--footer-h); }

    /* ===========================
      Desktop/Tablet (default): 1 layar, scroll di dalam box
    ============================ */
    html, body { height: 100%; overflow: hidden; margin: 0; }
    #appShell {
      height: 100vh;
      display: flex;
      flex-direction: column;
      min-height: 0;
      padding: 1rem 0 var(--footer-h);
    }
    #mainGrid { flex: 1 1 auto; min-height: 0; overflow: hidden; }

    /* Kolom */
    #leftCol, #middleCol {
      min-height: 0;
      display: flex;
      flex-direction: column;
      padding-top: .5rem;
    }

    /* Right Aside: hormati .hidden agar benar2 tidak makan tinggi */
    #rightAside { min-height: 0; padding-top: .5rem; overflow: hidden; }
    #rightAside.hidden { display: none !important; }
    #rightAside:not(.hidden) { display: flex; flex-direction: column; }

    /* Kartu & isi scroll (desktop) */
    #resultsWrap { min-height: 0; }
    #resultsList { flex: 1 1 auto; overflow: auto; overscroll-behavior: contain; }
    #detailWrap  { flex: 1 1 auto; min-height: 0; overflow: auto; overscroll-behavior: contain; }
    #adminBar, #liveAssistantBox{ max-height: 100%; overflow: auto; overscroll-behavior: contain; }
   /* Desktop: Akronim = flex column, scroller di bawah filter */
    #akronimBox{
      display:flex;            /* ⬅️ penting */
      flex-direction:column;   /* ⬅️ penting */
      min-height:0;
      height:100%;
      overflow:hidden;         /* list scroll di child, bukan di sini */
    }
    #akronimBox:not(.hidden){ display:flex; flex-direction:column; }

    /* pastikan akronim bisa benar2 ketutup */
    #akronimBox.hidden{ display: none !important; }
    #akronimScroll{
      flex:1 1 auto;           /* ⬅️ ambil sisa tinggi kartu */
      min-height:0;
      overflow:auto;           /* ⬅️ scroller hanya di sini */
      overscroll-behavior:contain;
    }

    /* Background */
    .bg-custom {
      background-image: url('assets/Artboard.png');
      background-size: cover; background-position: center; background-repeat: no-repeat;
    }

    /* ===========================
      Scrollline custom (desktop)
    ============================ */
    .scrollline {
      position: absolute; right: 8px; width: 8px;
      background: #1E40AF; border-radius: 9999px;
      cursor: pointer; z-index: 10; opacity: .8;
    }
    .scrollline__thumb{
      position: absolute; left: -2px; right: -2px; height: 30px;
      background: #F6E049; border-radius: 9999px; z-index: 1;
      box-shadow:
        inset 0 0 0 2px #1E40AF,
        0 0 0 1px #0B2E8A,
        0 4px 10px rgba(0,0,0,.18);
      transition: top .06s linear, height .06s linear, transform .12s ease, box-shadow .12s ease;
      cursor: grab;
    }
    .scrollline__thumb:hover{
      transform: scaleX(1.06);
      box-shadow:
        inset 0 0 0 2px #1E40AF,
        0 0 0 1px #0B2E8A,
        0 6px 14px rgba(0,0,0,.22);
    }
    .scrollline__thumb.dragging{
      cursor: grabbing; transform: scaleX(1.08);
      box-shadow:
        inset 0 0 0 2px #1E40AF,
        0 0 0 1px #0B2E8A,
        0 8px 18px rgba(0,0,0,.28);
    }
    .hide-native-scroll { scrollbar-width: none; }
    .hide-native-scroll::-webkit-scrollbar { width: 0; height: 0; }
    

    /* ===========================
      HERO
    ============================ */
    .hero{
      min-height: 58vh;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding-top: 8rem;
      transition: min-height .35s ease, margin .35s ease, padding .35s ease, transform .35s ease;
    }
    .hero.hero--collapsed{ min-height: auto; padding: .75rem 0 0; }

    /* ===========================
      Misc
    ============================ */
    .card-tall { min-height: 0; }
    #logoTitle { display: flex; justify-content: center; align-items: center; margin-bottom: 2rem; }
    #logoTitle img { height: 5rem; }
    button#clearBtn { margin-left: -2rem; }
    /* #detailCat { display: none !important; }  sembunyikan chip kategori di detail */

    /* ===========================
      Search bar (desktop)
    ============================ */
    .searchForm { width: 500px; transition: width .4s ease; }
    .searchForm.expanded { width: 800px; }

    /* Baris search (desktop) */
    #searchRow { flex-wrap: nowrap; }
    #searchOuter { transition: margin .3s ease; }

    /* Saat tools (topActions) dibuka di desktop: geser sedikit ke kiri */
    .tools-open #searchOuter { margin-left: 0 !important; margin-right: auto !important; }
    .tools-open #searchRow { justify-content: flex-start; padding-left: 4rem; }

    /* Ikon hamburger */
    #toggleAsideBtn .bar{
      display: block; height: .5rem; border-radius: 9999px;
      background: #2563eb; transition: width .2s ease, margin .2s ease;
    }
    #toggleAsideBtn .bar + .bar { margin-top: .25rem; }
    #toggleAsideBtn .bar-mid { width: .875rem; }
    #toggleAsideBtn[aria-expanded="true"] .bar-mid { width: 1.5rem; }

    /* ===========================
      Elevation (shadow) untuk kartu utama
    ============================ */
    #resultsWrap,        /* kiri */
    #detailWrap,         /* tengah */
    #adminBar,           /* kanan: Admin */
    #liveAssistantBox, 
    #akronimBox {  /* kanan: Live Assistance */
      box-shadow:
        0 14px 28px rgba(0,0,0,.12),
        0 10px 10px rgba(0,0,0,.06);
    }
    /* Jangan clip bayangan di level kolom */
    #leftCol, #middleCol, #rightAside { overflow: visible !important; }

    /* jaga agar newline tampil sebagai baris baru */
    #detailBody { white-space: pre-line; }


    /* ===========================
      Tablet+ : kembalikan animasi lebar form
    ============================ */
    @media (min-width: 768px){
      .searchForm { width: 500px; }
      .searchForm.expanded { width: 800px; }
    }

    /* =================================================================
      MOBILE (≤640px): halaman bebas scroll, tools jadi baris bawah search
      ================================================================= */
    @media (max-width: 640px){
      :root { --footer-h: 64px; }

      /* Halaman boleh scroll (bukan fixed 1 layar) */
      html, body { height: auto; min-height: 100%; overflow: auto; }
      #appShell { height: auto; min-height: 100%; padding-top: 1rem; padding-bottom: 0; }
      #mainGrid {
        gap: .5rem; padding-left: .75rem; padding-right: .75rem;
        min-height: 0; overflow: visible;
      }
      #leftCol, #middleCol, #rightAside { min-height: auto; overflow: visible; }

      /* Box mengikuti konten (hindari nested scroll di HP) */
      #resultsWrap, #detailWrap, #adminBar, #liveAssistantBox {
        height: auto !important; max-height: none !important; overflow: visible;
      }
      #resultsList { max-height: none; overflow: visible; }

      /* Matikan scrollline custom di HP */
      .scrollline { display: none !important; }

      /* HERO lebih pendek */
      .hero { min-height: 34vh; padding-top: 2rem; }
      .hero.hero--collapsed { min-height: auto; padding-top: .5rem; }

      /* Search full width, tombol menu di kanan, tools di baris bawah */
      #searchRow {
        display: grid;
        grid-template-columns: 1fr auto;  /* kiri: form; kanan: tombol */
        grid-auto-rows: auto;
        align-items: center;
        gap: .5rem;
      }
      #searchForm {
        grid-column: 1 / 2;
        width: 100% !important; flex: 1 1 auto; min-width: 0;
      }
      .searchForm.expanded { width: 100% !important; } /* cegah melebar di HP */
      #toggleAsideBtn {
        grid-column: 2 / 3; width: 44px; height: 44px; flex: 0 0 44px; margin: 0;
      }

      /* TopActions (tombol tools) sebagai baris di bawah search */
      #topActions{
        position: static !important;
        grid-column: 1 / -1;
        order: 2;
        margin-top: .25rem;
        display: none; gap: .5rem; justify-content: flex-start;
        background: transparent; border: 0; padding: 0; box-shadow: none;
      }
      #topActions:not(.hidden) { display: flex; }
      #topActions .rounded-2xl {
        padding: .5rem .75rem; font-size: .9rem; white-space: nowrap;
      }

      /* Host panel (Admin/Live) tepat di bawah TopActions */
      #toolsMobileHost{
        display: block;
        grid-column: 1 / -1;
        order: 3;
        margin-top: .25rem;
      }
      #toolsMobileHost > #adminBar,
      #toolsMobileHost > #liveAssistantBox{
        border-radius: .75rem;
        border: 1px solid #e5e7eb;
        padding: .75rem;
        background: #fff;
        box-shadow:
          0 14px 28px rgba(0,0,0,.12),
          0 10px 10px rgba(0,0,0,.06);
      }

      /* Kartu lebih kompak */
      #resultsWrap, #detailWrap { border-width: 1.5px; padding: .75rem; }

      /* Matikan efek “geser” tools-open di HP */
      .tools-open #searchOuter { margin: 0 !important; }
      .tools-open #searchRow { justify-content: center; padding-left: 0 !important; }

      /* Footer tidak fixed di HP */
      footer { position: static !important; }
      footer p { font-size: 12px; line-height: 1.35; text-wrap: balance; }

      /* Saat mode search aktif, rapatkan jarak hero → grid */
      body.search-mode #mainGrid { margin-top: .25rem !important; padding-top: 0 !important; }
      body.search-mode .hero.hero--collapsed { padding-bottom: 0 !important; }

      /* Default kecil saat bukan search-mode (antisipasi mt/py dari markup) */
      #mainGrid { margin-top: 0 !important; padding-top: .25rem; }

      /* Pagination area tampil di HP */
      #paginationWrap { display: flex !important; }

      #akronimBox{
        height:auto !important;
        max-height:none !important;
        overflow:visible !important;
      }
      #akronimScroll{
        height:auto !important;
        max-height:none !important;
        overflow:visible !important;
      }
    }
    /* bantu wrapping judul agar rapi di layar sempit */
    @supports (text-wrap: balance){
      #logoTitle h1, #logoTitle p { text-wrap: balance; }
    }

  </style>
</head>
<body class="bg-custom text-gray-800 font-sans md:h-screen md:overflow-hidden">
  <div id="appShell" class="max-w-6xl mx-auto h-full flex flex-col px-4 md:px-6 pt-4 pb-2">
    <!-- HERO WRAP -->
    <section id="heroWrap" class="hero">
      <div class="max-w-6xl mx-auto px-1.5 md:px-6 py-4 md:py-4">
        <!-- Header -->
        <div id="logoTitle" class="mb-6">
          <div class="mx-auto w-full max-w-3xl">
            <div class="grid items-center gap-3 md:gap-5 grid-cols-1 md:grid-cols-[auto,1fr]">
              <!-- Logo -->
              <img src="assets/logo_jakarta.png" alt="Logo DKI Jakarta"
                  class="h-14 md:h-20 mx-auto md:mx-0 rounded-xl" />

              <!-- Judul + subjudul -->
              <div class="text-center md:text-left">
                <h1 class="leading-tight font-extrabold uppercase tracking-tight text-blue-700
                          text-[clamp(1.8rem,3vw,2.5rem)]">
                  CONNECT KE NEK DKI JAKARTA
                </h1>
                <p class="mt-1 italic font-semibold text-red-500
                          text-[clamp(1rem,2.5vw,1.6rem)]">
                  Pusat Bantuan Penyelenggaraan NEK DKI Jakarta
                </p>

                <!-- aksen halus di desktop -->
                <!-- <div class="hidden md:block h-1 w-24 bg-blue-600/80 rounded-full mt-2"></div> -->
              </div>
            </div>
          </div>
        </div>

        <!-- Search -->
        <div id="searchOuter" class="relative max-w-4xl mx-auto">
          <div id="searchRow" class="flex gap-1 items-stretch justify-center flex-nowrap">
            <!-- Form Search -->
            <form id="searchForm" class="searchForm flex rounded-full border-2 border-blue-500 bg-white pl-3 pr-0.5 shadow-sm">
              <input
                type="text"
                id="searchInput"
                placeholder="Cari bantuan… (mis. PTBAE-PU, SRN-PPI, ETS)"
                class=" flex-grow h-12 px-3 outline-none rounded-l-full placeholder-blue-300"
                onfocus="expandSearchForm()"
                onblur="contractSearchForm()"
              />
              <button id="clearBtn" type="button" title="Bersihkan"
                class="hidden rounded-xl px-2 py-1 text-sm text-gray-500 hover:bg-gray-100">✕
              </button>
              <button type="submit"
                class="flex items-center justify-center h-11 w-11 rounded-full bg-lime-400 text-blue-600 hover:bg-lime-500 transition ml-2 mt-0.5">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                  viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z" />
                </svg>
              </button>
            </form>

            <!-- Tombol toggle aside -->
            <button id="toggleAsideBtn" onclick="toggleTopActions()" title="Buka Bantuan"
              class="flex items-center justify-center h-12 w-12 rounded-lg "
              aria-expanded="false" aria-controls="topActions">
              <span class="sr-only">Buka Bantuan</span>

              <!-- ikon manual -->
              <span class="sr-only">Buka Bantuan</span>
              <div class="pointer-events-none flex flex-col items-start justify-center">
                <span class="bar" style="width:1.5rem"></span>
                <span class="bar bar-mid"></span>
                <span class="bar" style="width:1.5rem"></span>
              </div>
            </button>
            <div id="topActions" class=" hidden flex gap-2">
              <button id="btnAkronimToggle" onclick="toggleAkronim()"
                class="rounded-2xl border bg-white px-4 shadow-sm text-sm font-semibold text-blue-700 hover:text-green-700">
                Akronim
              </button>

              <button id="btnAdminToggle" onclick="toggleAdminBar()"
                class="rounded-2xl border bg-white px-4 shadow-sm text-sm font-semibold text-blue-700 hover:text-green-700"
                title="Mode Admin">+Tambah Informasi
              </button>

              <button id="btnAssistToggle" onclick="toggleLiveAssistant()"
                class="rounded-2xl border bg-white px-4 shadow-sm text-sm font-semibold text-blue-700 hover:text-green-700">
                Live Assistance
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Grid Utama -->
    <main id="mainGrid" class="flex-1 min-h-0 overflow-hidden grid grid-cols-1 md:grid-cols-12 auto-rows-fr gap-4 pt-2 pb-0 px-4 md:px-10">
      <!-- Kiri -->
     <section id="leftCol"   class="order-2 md:order-1 md:col-span-3 min-h-0 h-full overflow-hidden">
        <div id="resultsWrap" class="hidden h-full flex flex-col rounded-3xl border-2 border-blue-500 bg-white p-2 shadow-sm card-tall">
          <div id="resultsMeta" class="px-3 py-2 text-sm text-gray-500"></div>
          <ul id="resultsList"
            class="divide-y flex-1 overflow-auto overscroll-contain hide-native-scroll"
            tabindex="0" aria-label="Daftar hasil"></ul>
          <div id="paginationWrap" class="hidden px-3 py-3 border-t flex justify-center"></div>
        </div>
      </section>

      <!-- Tengah -->
      <section id="middleCol" class="order-3 md:order-2 md:col-span-5 min-h-0 h-full overflow-hidden">
        <div id="detailWrap" class="hidden h-full overflow-auto overscroll-contain rounded-3xl border-2 border-blue-500 bg-white p-6 shadow-sm hide-native-scroll card-tall">
          <div class="mb-2 flex items-start justify-between gap-3">
            <div class="flex items-center gap-2">
              <span id="detailCat" class="rounded-full border px-2 py-0.5 text-xs text-gray-600"></span>
            </div>
            <div id="detailActions" class="hidden shrink-0 space-x-2">
              <button id="detailEditBtn" class="px-3 py-1.5 text-xs rounded-full border border-violet-200 text-violet-700 hover:bg-violet-50">Edit</button>
              <button id="detailDeleteBtn" class="px-3 py-1.5 text-xs rounded-full border border-rose-200 text-rose-700 hover:bg-rose-50">Hapus</button>
            </div>
          </div>

          <!-- View mode -->
          <div id="detailView">
            <h1 id="detailTitle" class="text-2xl font-semibold text-blue-700"></h1>
            <p id="detailBody" class="mt-3 text-gray-700"></p>
            <img id="detailImage" class="mt-4 hidden rounded-xl border border-gray-200 shadow-sm max-h-64 object-contain"
                alt="Gambar FAQ">
            <div id="detailLinksWrap" class="mt-6 hidden">
              <a id="detailLinkBtn" href="#" target="_blank"
                class="inline-flex items-center text-md rounded-full border-2 border-blue-500  px-4 py-1 bg-lime-400 text-blue-800 font-bold hover:bg-gray-100">
                Referensi
              </a>
            </div>
          </div>

          <!-- Inline edit mode (admin) -->
          <form id="detailEditForm" class="hidden mt-2 space-y-3">
            <input id="editTitle" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500" />
            <textarea id="editContent" rows="6" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500"></textarea>
              <p class="mb-3 text-xs text-gray-500">
                Tambah gambar: <code>&lt;img src="URL_GAMBAR" alt="deskripsi"&gt;</code>
              </p>
            <input id="editUrlLink" type="url"
              class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500"
              placeholder="URL Link (opsional)">
            <input id="editImageUrl" type="url"
              class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500"
              placeholder="Image URL (opsional)">
            <div class="flex items-center gap-2">
              <button id="detailSaveBtn" class="px-3 py-2 text-sm rounded-lg bg-violet-600 text-white hover:bg-violet-700" type="submit">Simpan</button>
              <button id="detailCancelBtn" class="px-3 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300" type="button">Batal</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Kanan: aside (hasil dari tombol topActions) -->
      <aside id="rightAside" class="hidden order-1 md:order-3 md:col-span-4 min-h-0 h-full overflow-hidden space-y-2">

        <!-- Admin Bar (tersembunyi di awal) -->
        <div id="adminBar" class="hidden mb-8 p-4 bg-violet-50 border border-violet-200 rounded-xl max-h-full overflow-auto overscroll-contain hide-native-scroll">
          <div class="flex flex-wrap items-center gap-3">
            <div id="adminKeyRow" class="relative flex-1 min-w-[200px] max-w-full">
              <input id="adminKeyInput" type="password" placeholder="Masukkan Admin Key"
                class="w-full p-2 pr-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500"
                aria-label="Admin key"/>
              <button type="button" id="togglePwdBtn"
                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700" title="Lihat/Sembunyikan password"
                aria-label="Lihat atau sembunyikan password">
                <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
              </button>
            </div>

            
            <button id="adminLoginBtn" class="px-3 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700"> Login </button>
            <button id="adminLogoutBtn" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 hidden">Logout</button>
            <span id="adminStatus" class="text-sm text-gray-700"></span>
          </div>

          <!-- Admin Forms -->
          <div id="adminForms" class="hidden mt-4 grid gap-4">
            <!-- Tambah FAQ -->
            <div class="bg-white p-4 border rounded-xl shadow-sm w-full">
              <h3 class="font-semibold mb-3 text-violet-700">Tambah FAQ</h3>
              <input id="faqTitle" class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-violet-500" placeholder="Pertanyaan (title)"/>
              <textarea id="faqContent" rows="4" class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-violet-500" placeholder="Jawaban (content)"></textarea>
              <input id="faqImageUrl" type="url" class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-violet-500" placeholder="Image URL (opsional)"/>
              <input id="faqUrlLink" type="url" class="w-full p-2 border rounded mb-3 focus:outline-none focus:ring-2 focus:ring-violet-500" placeholder="URL Link (opsional)"/>
              <p class="mb-3 text-xs text-gray-500">Drive direct: https://lh3.googleusercontent.com/d/FILE_ID=w1200</p>
              <button id="faqAddBtn" class="w-full px-3 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700">Tambah FAQ</button>
            </div>
            <!-- Tambah Glosarium -->
            <div class="bg-white p-4 border rounded-xl shadow-sm w-full">
              <h3 class="font-semibold mb-3 text-green-700">Tambah Glosarium</h3>
              <input id="gloTitle" class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Istilah (title)"/>
              <textarea id="gloContent" rows="4" class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Definisi (content)"></textarea>
              <input id="gloImageUrl" type="url" class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Image URL (opsional)"/>
              <input id="gloUrlLink" type="url" class="w-full p-2 border rounded mb-3 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="URL Link (opsional)"/>
              <p class="mb-3 text-xs text-gray-500">Drive direct: https://lh3.googleusercontent.com/d/FILE_ID=w1200</p>
              <button id="gloAddBtn" class="w-full px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Tambah Istilah</button>
            </div>
            <!-- Tambah Akronim -->
            <div class="bg-white p-4 border rounded-xl shadow-sm w-full">
              <h3 class="font-semibold mb-3 text-sky-700">Tambah Akronim</h3>
              <input id="akrTitle" class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-sky-500"
                    placeholder="Singkatan (title), mis. MRV"/>
              <textarea id="akrContent" rows="3"
                class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-sky-500"
                placeholder="Kepanjangan / penjelasan (content)"></textarea>
              <input id="akrUrlLink" type="url"
                class="w-full p-2 border rounded mb-3 focus:outline-none focus:ring-2 focus:ring-sky-500"
                placeholder="URL Link (opsional)"/>
              <button id="akrAddBtn"
                class="w-full px-3 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700">Tambah Akronim</button>
            </div>
          </div>
        </div>

        <!-- Panel Akronim (list tabel akronim) -->
        <div id="akronimBox"
            class="hidden h-full rounded-2xl border bg-white p-4 shadow-sm border-2 border-blue-500">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-sky-700">Daftar Akronim</h3>
          </div>

          <!-- Filter TETAP DI LUAR scroller -->
          <input id="akrFilter" placeholder="Filter akronim…"
            class="mt-3 w-full rounded-xl border px-3 py-2 outline-none bg-white sticky top-0 z-10" />

          <!-- Inilah area yang scroll -->
          <div id="akronimScroll"
              class="mt-3 flex-1 overflow-auto overscroll-contain hide-native-scroll relative">
            <table class="w-full text-sm">
              <tbody id="akronimList"></tbody>
            </table>
          </div>

          <!-- Pagination untuk HP -->
          <div id="akrPaginationWrap" class="mt-2 flex items-center justify-center gap-1 sm:hidden"></div>
        </div>

        <!-- Kotak Live Assistance -->
        <div id="liveAssistantBox" class="hidden mt-4 rounded-2xl border bg-violet-50 p-5 shadow-sm max-h-full overflow-auto overscroll-contain hide-native-scroll">
          <h3 class="text-lg font-semibold">Live Assistance via Email</h3>
          <p class="mt-1 text-sm text-gray-600">Butuh bantuan? Kirim pertanyaan Anda melalui email.</p>
          <input id="assistantSubject" placeholder="Subjek email" class="mt-3 w-full rounded-xl border px-3 py-2 outline-none" />
          <textarea id="assistantMsg" placeholder="Tulis pesan Anda…" rows="6" class="mt-3 w-full rounded-xl border px-3 py-2 outline-none"></textarea>
          <button onclick="sendToEmail()" class="mt-3 w-full rounded-xl bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">Kirim via Email</button>
        </div>
      </aside>
      <!-- Tailwind safelist (jangan dihapus) -->
      <div class="hidden">
        <span class="md:col-span-8 md:col-span-4"></span>
      </div>
    </main>

    <!-- Footer -->
    <footer class="fixed bottom-0 inset-x-0 pt-2 pb-5">
      <p class="text-sm text-blue-700 text-center">Dibangun oleh 
        <img src="assets/logo-dlh.png" alt="Logo DLH" class="inline h-8 w-8 mx-1" />
        Dinas Lingkungan Hidup. didukung oleh Yayasan Generasi Hijau Indonesia</p>
    </footer>
  </div>

  <script>
    // ===== Admin toggle =====
    const adminBar = document.getElementById('adminBar');
    const adminKeyInput = document.getElementById('adminKeyInput');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const adminStatus = document.getElementById('adminStatus');
    const adminForms = document.getElementById('adminForms');
    const adminKeyRow  = document.getElementById('adminKeyRow');
    const togglePwdBtn = document.getElementById('togglePwdBtn');
    const adminKeyInputEl = document.getElementById('adminKeyInput');

    // toggle show/hide password
    togglePwdBtn?.addEventListener('click', () => {
      const showing = adminKeyInputEl.type === 'text';
      adminKeyInputEl.type = showing ? 'password' : 'text';
      document.getElementById('eyeIcon')?.classList.toggle('opacity-60', !showing);
    });

    let adminKey = localStorage.getItem('adminKey') || null;
    const isAdmin = () => !!adminKey;

    function setAdminKey(key) {
      adminKey = key || null;
      if (key) localStorage.setItem('adminKey', key);
      else localStorage.removeItem('adminKey');
      renderAdminState();
    }

    function renderAdminState() {
      const detailActions = document.getElementById('detailActions');
      if (isAdmin()) {
        adminKeyRow?.classList.add('hidden');
        adminLoginBtn?.classList.add('hidden');
        adminLogoutBtn?.classList.remove('hidden');
        adminStatus.textContent = 'Mode Admin aktif';
        adminForms?.classList.remove('hidden');
        adminKeyInputEl.value = '';             
        adminKeyInputEl.type  = 'password';       
        detailActions?.classList.remove('hidden');
      } else {
        adminKeyRow?.classList.remove('hidden');
        adminLoginBtn?.classList.remove('hidden');
        adminLogoutBtn?.classList.add('hidden');
        adminStatus.textContent = '';
        adminForms?.classList.add('hidden');
        detailActions?.classList.add('hidden');
      }
    }

    // validasi admin key ke server (gunakan header x-admin-key)
    adminLoginBtn?.addEventListener('click', async () => {
      const key = adminKeyInputEl.value.trim();
      if (!key) return alert('Masukkan admin key');
      try {
        const res = await fetch('/health', { headers: { 'x-admin-key': key } });
        if (res.status === 401) {
          alert('Admin key salah');
          return;
        }
        setAdminKey(key);
      } catch (e) {
        alert('Gagal konek ke server');
      }
    });

    adminLogoutBtn?.addEventListener('click', () => {
      setAdminKey(null);
      // ✅ reset tampilan input password
      adminKeyInputEl.type = 'password';
      document.getElementById('eyeIcon')?.classList.remove('opacity-60');
    });


    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.altKey && (e.key === 'a' || e.key === 'A')) {
        e.preventDefault();
        toggleAdminBar();
      }
    });
    if (new URLSearchParams(location.search).get('admin') === '1') toggleAdminBar(true);


    const headersJSON = () => {
      const h = { 'Content-Type': 'application/json' };
      if (isAdmin()) h['x-admin-key'] = adminKey;
      return h;
    };

    // ===== Elements =====
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');

    const resultsWrap = document.getElementById('resultsWrap');
    const resultsMeta = document.getElementById('resultsMeta');
    const resultsList = document.getElementById('resultsList');
    const paginationWrap = document.getElementById('paginationWrap');

    const detailWrap = document.getElementById('detailWrap');
    const detailCat = document.getElementById('detailCat');
    const detailTitle = document.getElementById('detailTitle');
    const detailBody = document.getElementById('detailBody');
    const detailLinksWrap = document.getElementById('detailLinksWrap');
    const detailLinkBtn = document.getElementById('detailLinkBtn');
    const detailEditBtn = document.getElementById('detailEditBtn');
    const detailDeleteBtn = document.getElementById('detailDeleteBtn');
    const detailEditForm = document.getElementById('detailEditForm');
    const detailView = document.getElementById('detailView');
    const editTitle = document.getElementById('editTitle');
    const editContent = document.getElementById('editContent');
    const detailSaveBtn = document.getElementById('detailSaveBtn');
    const detailCancelBtn = document.getElementById('detailCancelBtn');
    const detailImage = document.getElementById('detailImage');
    const editImageUrl = document.getElementById('editImageUrl');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const copyLinkStatus = document.getElementById('copyLinkStatus');
    const assistantMsg = document.getElementById('assistantMsg');
    const hero = document.getElementById('heroWrap');
    const isMobile = () => window.matchMedia('(max-width: 640px)').matches;

    function setHeroCollapsed(on){ hero?.classList.toggle('hero--collapsed', !!on); }

    // Hitung tinggi sisa layar & set ke box
    function setPanelHeights() {

      if (window.innerWidth <= 640) {
        ['resultsWrap','detailWrap','adminBar','liveAssistantBox, '].forEach(id=>{
          const el = document.getElementById(id);
          if (el){ el.style.height = ''; el.style.maxHeight = ''; el.style.overflow = ''; }
        });
        return;
      }
      const hero   = document.getElementById('heroWrap');
      const grid   = document.getElementById('mainGrid');
      const root   = document.documentElement;

      const vh       = window.innerHeight;
      const heroH    = hero ? hero.offsetHeight : 0;

      // ambil tinggi footer dari CSS var (lebih akurat untuk footer fixed)
      const footerH  = parseFloat(getComputedStyle(root).getPropertyValue('--footer-h')) || 0;

      const gp       = grid ? getComputedStyle(grid) : null;
      const gridPadY = gp ? (parseFloat(gp.paddingTop) + parseFloat(gp.paddingBottom)) : 0;

      // ruang yang bisa dipakai box
      const avail = Math.max(320, vh - heroH - footerH - gridPadY);

      const resultsWrap = document.getElementById('resultsWrap');
      const detailWrap  = document.getElementById('detailWrap');
      const adminBar    = document.getElementById('adminBar');
      const liveBox     = document.getElementById('liveAssistantBox');

      if (resultsWrap) resultsWrap.style.height = avail + 'px';
      if (detailWrap)  detailWrap.style.height  = avail + 'px';
      if (adminBar)    adminBar.style.maxHeight = avail + 'px';
      if (liveBox)     liveBox.style.maxHeight  = avail + 'px';

      if (typeof refreshScrolllines === 'function') refreshScrolllines();
    }
    window.addEventListener('resize', setPanelHeights);

    function isToolsOpen(){
      const adminBox = document.getElementById('adminBar');
      const liveBox  = document.getElementById('liveAssistantBox');
      const akrBox   = document.getElementById('akronimBox');
      return (!!adminBox && !adminBox.classList.contains('hidden')) ||
            (!!liveBox  && !liveBox.classList.contains('hidden'))  ||
            (!!akrBox   && !akrBox.classList.contains('hidden'));
    }

    function updateSearchPosition(){
      const q = (document.getElementById('searchInput')?.value || '').trim();
      const stickTop = q.length > 0 || isToolsOpen();  // ← kunci: tools open → tetap di atas
      if (stickTop){
        setHeroCollapsed(true);
        document.body.classList.add('search-mode');
      }else{
        setHeroCollapsed(false);
        document.body.classList.remove('search-mode');
      }
    }



    function showLanding(){
      // Jika tools (Admin/Live) sedang terbuka → tetap di atas
      if (isToolsOpen()){
        setHeroCollapsed(true);
        document.body.classList.add('search-mode');
      } else {
        // Normal: landing (search di tengah)
        setHeroCollapsed(false);
        document.body.classList.remove('search-mode');
      }

      // hasil disembunyikan saat landing
      resultsWrap.classList.add('hidden');
      detailWrap.classList.add('hidden');

      setPanelHeights();
    }

    function showSearch(){
      setHeroCollapsed(true);                 // hero kecil, TANPA margin negatif
      document.body.classList.add('search-mode');
      resultsWrap.classList.remove('hidden');
      if (isMobile()) document.getElementById('rightAside')?.classList.add('hidden');
      setPanelHeights();
    }



    // ===== State =====
    let searched = false;
    let ITEMS = [];        // gabungan FAQ + Glosarium
    let FILTERED = [];     // hasil filter
    // let currentPage = 1;   // halaman aktif
    // const PAGE_SIZE = 5;   // LIMIT 5 / halaman
    let activeItem = null; // item aktif di detail
    let activeIndex = -1;  // untuk keyboard nav

    function expandSearchForm() {
      if (window.innerWidth >= 768) { // hanya desktop/tablet
        document.getElementById("searchForm").classList.add("expanded");
      }
    }
    function contractSearchForm() {
      if (window.innerWidth >= 768) {
        if (!document.getElementById("searchInput").value) {
          document.getElementById("searchForm").classList.remove("expanded");
        }
      }
    }

    // ===== Router Helpers (deep-link) =====
    function stateToParams({q, page, id, type}) {
      const sp = new URLSearchParams(location.search);
      if (q != null) sp.set('q', q); else sp.delete('q');
      // if (page) sp.set('p', String(page)); else sp.delete('p');
      if (id && type) { sp.set('id', id); sp.set('t', type); } else { sp.delete('id'); sp.delete('t'); }
      return sp.toString();
    }
    function pushRoute(params){ history.pushState(null, '', `${location.pathname}?${params}${location.hash}`); }
    function replaceRoute(params){ history.replaceState(null, '', `${location.pathname}?${params}${location.hash}`); }
    function readRoute(){
      const sp = new URLSearchParams(location.search);
      return { q: sp.get('q') || '', 
        // page: parseInt(sp.get('p')||'1',10) || 1, 
        id: sp.get('id') || null, 
        type: sp.get('t') || null 
      };
    }

    // ===== Helpers =====
    function escapeHtml(s=''){return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
    function highlight(text='', query=''){
      if(!query) return escapeHtml(text);
      const q = query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      return escapeHtml(text).replace(new RegExp(`(${q})`,'gi'),'<mark class="bg-yellow-200 px-0.5 rounded">$1</mark>');
    }

    function normalizeImageUrl(u){
      if(!u) return null;
      const s = u.trim();
      // convert viewer link gdrive -> direct
      const m = s.match(/drive\.google\.com\/file\/d\/([^/]+)/);
      if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;
      // allow relative (assets/xxx.png)
      if(!/^https?:\/\//i.test(s) && !s.startsWith('/')) return `/assets/${s}`;
      return s;
    }

    document.getElementById('logoTitle').addEventListener('click', () => {
      searchInput.value = '';
      clearBtn.classList.add('hidden');
      resultsWrap.classList.add('hidden')
      detailWrap.classList.add('hidden'); 
      detailTitle.textContent = '';
      detailBody.innerHTML = '';
      // currentPage = 1;
      FILTERED = [];
      setHeroCollapsed(false); 
      const params = stateToParams({ q: '', page: 1 });
      replaceRoute(params);
      
    });

    function showLanding() {
      setHeroCollapsed(false);
      resultsWrap.classList.add('hidden');
      detailWrap.classList.add('hidden');
    }

    function showSearch() {
      setHeroCollapsed(true);
      resultsWrap.classList.remove('hidden');
      // detailWrap akan dibuka saat ada item
    }

    // letakkan dekat helper lain
    function moveSearchToTopForTools(){
      // kecilkan hero walau belum ada query
      setHeroCollapsed(true);
      // pastikan aside muncul & grid menyesuaikan
      ensureAsideVisible();
      applyAsideLayout();
      // hitung ulang tinggi panel agar tidak “pendek”
      if (typeof setPanelHeights === 'function') setPanelHeights();
    }


    // Kalau semua panel (Admin/Live) tertutup:
    function restoreSearchPositionIfNeeded() {
      const adminBox = document.getElementById('adminBar');
      const liveBox  = document.getElementById('liveAssistantBox');

      const adminOpen = !!(adminBox && !adminBox.classList.contains('hidden'));
      const liveOpen  = !!(liveBox  && !liveBox.classList.contains('hidden'));
      const hasQuery  = !!(searchInput && searchInput.value.trim().length);

      if (!adminOpen && !liveOpen) {
        if (hasQuery) {
          // user sudah ketik → tetap mode search (di atas)
          if (typeof showSearch === 'function') showSearch();
        } else {
          // tidak ada query → kembali landing (di tengah)
          if (typeof showLanding === 'function') showLanding();
        }
        if (typeof setPanelHeights === 'function') setPanelHeights();
      }
    }

    function setToolsIndicator({ adminOpen=false, akronimOpen=false, liveOpen=false }) {
      const btnAdmin = document.getElementById('btnAdminToggle');
      const btnAkr   = document.getElementById('btnAkronimToggle');
      const btnAsst  = document.getElementById('btnAssistToggle');

      const reset = (el) => {
        if (!el) return;
        el.classList.remove('text-green-700','text-sky-700','text-indigo-700','font-bold');
        el.classList.add('font-semibold');
        el.setAttribute('aria-pressed','false');
        el.style.color = '';
      };
      const mark = (el, cls) => {
        if (!el) return;
        el.classList.remove('font-semibold');
        el.classList.add(cls,'font-bold');
        el.setAttribute('aria-pressed','true');
      };

      reset(btnAdmin); reset(btnAkr); reset(btnAsst);

      if (adminOpen)   mark(btnAdmin,'text-blue-700');
      if (akronimOpen) mark(btnAkr,'text-blue-700');
      if (liveOpen)    mark(btnAsst,'text-blue-700');
    }




    // ===== Fetch Data =====
    async function fetchData() {
      try {
        const [faqRes, gloRes] = await Promise.all([ fetch('/faq'), fetch('/glossary') ]);
        if (!faqRes.ok || !gloRes.ok) throw new Error('API error');

        const faqRows = await faqRes.json();
        const gloRows = await gloRes.json();

        const faqs = (faqRows || []).map(r => ({
          id: r.id ?? r.ID ?? r.Id ?? null,
          title: r.title ?? r.question ?? '',
          content: r.content ?? r.answer ?? '',
          image_url: r.image_url || null,
          link_url:  r.link_url  || null,
          category: 'FAQ',
          type: 'faq'
        }));

        const glossary = (gloRows || []).map(r => ({
          id: r.id ?? r.ID ?? r.Id ?? null,
          title: r.title ?? r.term ?? '',
          content: r.content ?? r.definition ?? '',
          image_url: r.image_url || null,
          link_url:  r.link_url  || null,
          category: 'Glosarium',
          type: 'glossary'
        }));

        ITEMS = [...faqs, ...glossary].filter(x => x.id && x.title);
        ITEMS.sort((a,b) => a.title.localeCompare(b.title, 'id', { sensitivity: 'base' }));

        if (!ITEMS.length) {
          resultsWrap.classList.remove('hidden');
          resultsMeta.textContent = '0 hasil';
          resultsList.innerHTML = '<div class="p-4 text-gray-500">Tidak ada data ditemukan.</div>';
        }
      } catch (e) {
        console.error('Gagal memuat data:', e);
        ITEMS = [];
        resultsWrap.classList.remove('hidden');
        resultsMeta.textContent = '';
        resultsList.innerHTML = '<div class="p-4 text-rose-600">Gagal memuat data. Coba muat ulang.</div>';
      }
    }

    // function paginate(list, page, size) {
    //   const totalPages = Math.max(1, Math.ceil(list.length / size));
    //   const p = Math.min(Math.max(1, page), totalPages);
    //   const start = (p - 1) * size;
    //   const end = start + size;
    //   return { page: p, totalPages, slice: list.slice(start, end) };
    // }

    // function renderPaginationCompact(totalPages) {
    //   paginationWrap.innerHTML = '';
    //   if (totalPages <= 1) { paginationWrap.classList.add('hidden'); return; }
    //   paginationWrap.classList.remove('hidden');

    //   const makeBtn = (label, {active=false, disabled=false, pageNum=null}={}) => {
    //     const btn = document.createElement('button');
    //     btn.textContent = label;
    //     btn.className =
    //       "px-3 py-1 rounded-lg border text-sm " +
    //       (active ? "bg-emerald-600 text-white border-emerald-600" : "hover:bg-gray-50") +
    //       (disabled ? " opacity-40 cursor-not-allowed" : "");
    //     if (!disabled && pageNum != null) {
    //       btn.addEventListener('click', () => { currentPage = pageNum; updateRouteAndUI(); });
    //     }
    //     paginationWrap.appendChild(btn);
    //   };
    //   const makeDots = () => {
    //     const span = document.createElement('span');
    //     span.textContent = '…';
    //     span.className = "px-2 text-gray-500";
    //     paginationWrap.appendChild(span);
    //   };

    //   makeBtn('‹', {disabled: currentPage===1, pageNum: currentPage-1});
    //   if (totalPages <= 7) {
    //     for (let i=1;i<=totalPages;i++){
    //       makeBtn(String(i), {active: i===currentPage, pageNum: i});
    //     }
    //   } else {
    //     makeBtn('1', {active: currentPage===1, pageNum: 1});
    //     if (currentPage > 3) makeDots();
    //     const start = Math.max(2, currentPage - 1);
    //     const end = Math.min(totalPages - 1, currentPage + 1);
    //     for (let p = start; p <= end; p++) makeBtn(String(p), {active: p===currentPage, pageNum: p});
    //     if (currentPage < totalPages - 2) makeDots();
    //     makeBtn(String(totalPages), {active: currentPage===totalPages, pageNum: totalPages});
    //   }
    //   makeBtn('›', {disabled: currentPage===totalPages, pageNum: currentPage+1});
    // }

    // ===== Pagination untuk MOBILE saja =====
    let currentPage = 1;                 // dipakai hanya saat mobile
    const PAGE_SIZE_MOBILE = 5;
    let akrCurrentPage = 1;
    const PAGE_SIZE_MOBILE_AKR = (typeof PAGE_SIZE_MOBILE !== 'undefined' && PAGE_SIZE_MOBILE) ? PAGE_SIZE_MOBILE : 8;

    function paginateMobile(list, page, size){
      const totalPages = Math.max(1, Math.ceil(list.length / size));
      const p = Math.min(Math.max(1, page || 1), totalPages);
      const start = (p - 1) * size;
      return { page: p, totalPages, slice: list.slice(start, start + size) };
    }

    function renderPaginationMobile(totalPages){
      const isMobile = window.matchMedia('(max-width: 640px)').matches;
      if (!isMobile || totalPages <= 1){
        paginationWrap.classList.add('hidden');
        paginationWrap.innerHTML = '';
        return;
      }
      paginationWrap.classList.remove('hidden');
      paginationWrap.innerHTML = '';

      const makeBtn = (label, pageNum, disabled=false, active=false) => {
        const b = document.createElement('button');
        b.textContent = label;
        b.className =
          "px-3 py-1 rounded-full border text-sm " +
          (active ? "bg-emerald-600 text-white border-emerald-600" : "bg-white") +
          (disabled ? " opacity-50 cursor-not-allowed" : " hover:bg-gray-50");
        if (!disabled) b.onclick = () => { currentPage = pageNum; renderResultsUI(); };
        paginationWrap.appendChild(b);
      };

      makeBtn('‹', Math.max(1, currentPage-1), currentPage===1);
      // tampilkan 1 … (p-1) p (p+1) … N
      const windowPages = [1, currentPage-1, currentPage, currentPage+1, totalPages]
        .filter((v,i,a) => v>=1 && v<=totalPages && a.indexOf(v)===i)
        .sort((a,b)=>a-b);

      let last = 0;
      windowPages.forEach(p => {
        if (p - last > 1){
          const dots = document.createElement('span');
          dots.textContent = '…';
          dots.className = "px-2 text-gray-500";
          paginationWrap.appendChild(dots);
        }
        makeBtn(String(p), p, false, p===currentPage);
        last = p;
      });

      makeBtn('›', Math.min(totalPages, currentPage+1), currentPage===totalPages);
    }


    // Function untuk menampilkan hasil pencarian dan memeriksa apakah ada hasil
    function renderResultsUI() {
      const q = (searchInput.value || '').trim();
      const isMobile = window.matchMedia('(max-width: 640px)').matches;

      resultsWrap.classList.remove('hidden');
      resultsList.innerHTML = '';

      if (!FILTERED.length){
        resultsMeta.textContent = '0 hasil';
        resultsList.innerHTML = '<div class="py-6 px-3 text-gray-500">Tidak ada hasil. Coba kata kunci lain.</div>';
        renderPaginationMobile(1);
        detailWrap.classList.add('hidden');
        if (typeof refreshScrolllines==='function') refreshScrolllines();
        setPanelHeights();
        return;
      }

      if (isMobile){
        // === MOBILE: pakai pagination agar list tidak panjang ===
        const { page, totalPages, slice } = paginateMobile(FILTERED, currentPage, PAGE_SIZE_MOBILE);
        currentPage = page; // clamp
        resultsMeta.textContent = `${FILTERED.length} hasil – halaman ${page} dari ${totalPages}`;

        slice.forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = `
            <button class="w-full text-left p-3 hover:bg-gray-50 focus:bg-emerald-50 outline-none rounded-lg"
                    data-id="${item.id}" data-type="${item.type}" tabindex="-1">
              <div class="flex items-center gap-2">
                <h3 class="font-semibold text-blue-700 ">${highlight(item.title, q)}</h3>
              </div>
              <p class="mt-1 line-clamp-2 text-sm text-gray-600">
                ${highlight((item.content || '').slice(0, 160) + ((item.content||'').length>160 ? '…':''), q)}
              </p>
            </button>`;
          resultsList.appendChild(li);
        });

        renderPaginationMobile(totalPages);
      } else {
        // === DESKTOP/TABLET: tampilkan semua, scroll di dalam box ===
        resultsMeta.textContent = `${FILTERED.length} hasil`;
        FILTERED.forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = `
            <button class="w-full text-left p-3 hover:bg-gray-50 focus:bg-emerald-50 outline-none rounded-lg"
                    data-id="${item.id}" data-type="${item.type}" tabindex="-1">
              <div class="flex items-center gap-2">
                <span class="rounded-full border px-2 py-0.5 text-xs text-gray-600">${item.category}</span>
                <h3 class="font-semibold text-blue-700">${highlight(item.title, q)}</h3>
              </div>
              <p class="mt-1 line-clamp-2 text-sm text-gray-600">
                ${highlight((item.content || '').slice(0, 160) + ((item.content||'').length>160 ? '…':''), q)}
              </p>
            </button>`;
          resultsList.appendChild(li);
        });
        paginationWrap.classList.add('hidden');
      }

      activeIndex = -1;

      if (typeof refreshScrolllines==='function') refreshScrolllines();
      setPanelHeights();
    }


    function renderDetail(item) {
      if (!item) {
        activeItem = null;
        detailWrap.classList.add('hidden');
        detailView.classList.add('hidden');
        detailTitle.textContent = '';
        detailBody.innerHTML = '';
        detailImage.classList.add('hidden');
        detailImage.src = '';
        detailLinksWrap.classList.add('hidden');
        detailLinkBtn.removeAttribute('href');  // <-- ganti dari detailLinks.innerHTML
        return;
      }

      detailWrap.classList.remove('hidden');
      activeItem = item;
      detailCat.textContent = item.category || '';
      detailTitle.textContent = item.title || '';
      
      const html = (item.content || '')
        .replace(/\r\n/g, '\n')
        .replace(/\\n/g, '\n');

      detailBody.innerHTML = item.content || '';

      const imgUrl = normalizeImageUrl(item.image_url);
      if (imgUrl) {
        detailImage.src = imgUrl;
        detailImage.referrerPolicy = 'no-referrer';
        detailImage.classList.remove('hidden');
        detailImage.onerror = () => detailImage.classList.add('hidden');
      } else {
        detailImage.src = '';
        detailImage.classList.add('hidden');
      }

      if (item.link_url) {
        detailLinksWrap.classList.remove('hidden');
        detailLinkBtn.href = item.link_url;
      } else {
        detailLinksWrap.classList.add('hidden');
        detailLinkBtn.removeAttribute('href');
      }

      renderAdminState();
      detailEditForm.classList.add('hidden');
      detailView.classList.remove('hidden');
      if (typeof refreshScrolllines==='function') refreshScrolllines(); setPanelHeights();
    }

    function showResultsUI() {
      resultsWrap.classList.remove('hidden');
      detailWrap.classList.remove('hidden');
    }

    function applyFilter() {
      const q = (searchInput.value || '').toLowerCase().trim();
      FILTERED = q ? ITEMS.filter(d => [d.title, d.content].some(t => t?.toLowerCase().includes(q))) : ITEMS.slice();
    }

    function updateRouteAndUI() {
      const params = stateToParams({ q: searchInput.value.trim(), page: currentPage, id: activeItem?.id, type: activeItem?.type });
      pushRoute(params);
      renderResultsUI();
      if (activeItem) renderDetail(activeItem);
    }

    async function doSearch(e) {
      if (e) e.preventDefault();
      
      const q = searchInput.value.trim();
      if (!q){
        if (isToolsOpen()){
          // tetap di atas, tapi kosongkan hasil
          updateSearchPosition();
          resultsWrap.classList.add('hidden');
          detailWrap.classList.add('hidden');
          // route tetap dibersihkan
          const params = stateToParams({ q: '', page: 1 });
          replaceRoute(params);
        } else {
          showLanding();
        }
        return;
      }

      setHeroCollapsed(true);
      resultsWrap.classList.remove('hidden');

      if (!ITEMS.length) await fetchData();  // Ambil data jika belum ada

      clearBtn.classList.toggle('hidden', !(searchInput.value || '').length);
      applyFilter();
      // currentPage = 1; // Reset ke halaman 1 setiap pencarian baru

      if (!searched) { searched = true; showResultsUI(); }

      renderResultsUI();
      renderDetail(FILTERED[0] || null);

      // Sync URL
      const params = stateToParams({ q: searchInput.value.trim(), page: currentPage, id: activeItem?.id, type: activeItem?.type });
      replaceRoute(params);

      // Jika hasil pencarian kosong, sembunyikan detail
      if (FILTERED.length === 0) {
        detailWrap.classList.add('hidden');
      }
    }

    function handleSearchResult(results) {
      if (results.length === 0) {
        renderDetail(null); // Kosongkan tampilan detail
        // Mungkin juga tampilkan pesan "Tidak ditemukan"
        return;
      }
      // Jika ada hasil, tampilkan yang pertama misalnya
      renderDetail(results[0]);
    }

    function applyAsideLayout() {
      const aside  = document.getElementById('rightAside');
      const middle = document.getElementById('middleCol');
      const left   = document.getElementById('leftCol');

      left.classList.remove('md:col-span-3','md:col-span-4');
      middle.classList.remove('md:col-span-5','md:col-span-8');

      if (aside.classList.contains('hidden')) {
        left.classList.add('md:col-span-4');
        middle.classList.add('md:col-span-8');
        document.body.classList.remove('aside-open');
      } else {
        left.classList.add('md:col-span-3');
        middle.classList.add('md:col-span-5');
        document.body.classList.add('aside-open');
      }
      setPanelHeights();
    }


    function ensureAsideVisible() {
      const aside = document.getElementById('rightAside');
      if (!aside) return;
      if (isMobile()) {
        // di HP: selalu hidden supaya tidak bikin gap
        if (!aside.classList.contains('hidden')) aside.classList.add('hidden');
        return;
      }
      // desktop/tablet: boleh tampilkan
      if (aside.classList.contains('hidden')) {
        aside.classList.remove('hidden');
        applyAsideLayout?.();
      }
    }

    function closeAsideIfEmpty() {
      const aside    = document.getElementById('rightAside');
      const adminBox = document.getElementById('adminBar');
      const liveBox  = document.getElementById('liveAssistantBox');
      const akrBox   = document.getElementById('akronimBox');

      // ✅ Tambahan khusus HP: aside selalu disembunyikan agar tidak bikin gap.
      // Tidak menyentuh indikator tombol, tidak panggil render lain → aman terhadap logika lama.
      if (isMobile()) {
        if (aside && !aside.classList.contains('hidden')) {
          aside.classList.add('hidden');
          document.body.classList.remove('aside-open');
          if (typeof applyAsideLayout === 'function') applyAsideLayout();
        }
        return; // ← penting: hentikan di sini untuk HP
      }

      // ====== (di bawah ini persis seperti kode lama Anda) ======
      const adminOpen = !!(adminBox && !adminBox.classList.contains('hidden'));
      const liveOpen  = !!(liveBox  && !liveBox.classList.contains('hidden'));
      const akrOpen = !!(akrBox && ! akrBox.classList.contains('hidden'));

      // kalau dua-duanya tertutup → tutup aside & reset tanda tombol
      if (!adminOpen && !liveOpen && !akrOpen) {
        if (aside && !aside.classList.contains('hidden')) {
          aside.classList.add('hidden');
        }
        document.body.classList.remove('aside-open');

        // reset indikator tombol (bold+warna kembali ke semula)
        if (typeof setToolsIndicator === 'function') {
          setToolsIndicator({ adminOpen: false, liveOpen: false });
        }

        // sinkron state panel kecil (aria-expanded), tidak menutupinya
        if (typeof syncTopActionsState === 'function') {
          syncTopActionsState();
        }

        // rapikan layout + tinggi + scrollline
        if (typeof applyAsideLayout === 'function') applyAsideLayout();
        if (typeof refreshScrolllines === 'function') refreshScrolllines();
        if (typeof setPanelHeights === 'function') setPanelHeights();
      }

      if (typeof restoreSearchPositionIfNeeded === 'function') {
        restoreSearchPositionIfNeeded();
      }
    }
    function hideAllToolsPanels() {
      const adminBox = document.getElementById('adminBar');
      const liveBox  = document.getElementById('liveAssistantBox');
      const akrBox   = document.getElementById('akronimBox');

      // Sembunyikan keduanya (tidak reset nilai/input apapun)
      if (adminBox) adminBox.classList.add('hidden');
      if (liveBox)  liveBox.classList.add('hidden');
      if (akrBox) akrBox.classList.add('hidden');

      // HP: sembunyikan host mobile kalau ada
      const host = document.getElementById('toolsMobileHost');
      if (host) host.classList.add('hidden');

      // Reset indikator tombol
      if (typeof setToolsIndicator === 'function') {
        setToolsIndicator({ adminOpen:false, liveOpen:false });
      }

      // Rapikan layout & posisi
      if (typeof closeAsideIfEmpty === 'function') closeAsideIfEmpty();
      if (typeof applyAsideLayout   === 'function') applyAsideLayout();
      if (typeof refreshScrolllines === 'function') refreshScrolllines();
      if (typeof setPanelHeights    === 'function') setPanelHeights();
      if (typeof restoreSearchPositionIfNeeded === 'function') restoreSearchPositionIfNeeded();
    } 

    function toggleAsideBtn() {
      const aside = document.getElementById('rightAside');
      const willShow = aside.classList.contains('hidden');
      aside.classList.toggle('hidden');
      if (willShow) document.body.classList.add('aside-open');
      else document.body.classList.remove('aside-open');
      applyAsideLayout();
    }

    // ===== Hamburger → topActions (panel kecil)
    function toggleTopActions(){
      const panel = document.getElementById('topActions');
      const btn   = document.getElementById('toggleAsideBtn');
      const mobile = isMobile();
      const willShow = panel.classList.contains('hidden');  // true = akan dibuka

      // Tampil/sembunyi baris tombol
      panel.classList.toggle('hidden');
      btn.setAttribute('aria-expanded', String(willShow));

      // Desktop boleh geser layout; HP jangan
      if (!mobile) document.body.classList.toggle('tools-open', willShow);
      else document.body.classList.remove('tools-open');

      // ❗ Saat DITUTUP → tutup semua isi tools
      if (!willShow) {
        hideAllToolsPanels();
      } else {
        // Saat dibuka di HP, pastikan host mobile sudah tepat posisinya
        if (mobile && typeof syncToolsMount === 'function') syncToolsMount();
      }
    }

    // Helper: apakah klik berada di "zona aman" (tidak menutup menu/panel)
    // function isInToolsSafeZone(target){
    //   const top   = document.getElementById('topActions');
    //   const btn   = document.getElementById('toggleAsideBtn');
    //   const admin = document.getElementById('adminBar');
    //   const live  = document.getElementById('liveAssistantBox');
    //   const host  = document.getElementById('toolsMobileHost'); // host mobile di bawah search
    //   const aside = document.getElementById('rightAside');      // panel di desktop

    //   return (
    //     (top   && top.contains(target))   ||
    //     (btn   && btn.contains(target))   ||
    //     (admin && admin.contains(target)) ||
    //     (live  && live.contains(target))  ||
    //     (host  && host.contains(target))  ||
    //     (aside && aside.contains(target))
    //   );
    // }

    // // Tutup TopActions & SEMUA panel HANYA jika klik benar-benar di luar SEMUA zona aman
    // document.addEventListener('click', (e) => {
    //   const box = document.getElementById('topActions');
    //   const btn = document.getElementById('toggleAsideBtn');
    //   if (!box || box.classList.contains('hidden')) return;

    //   if (isInToolsSafeZone(e.target)) return; // ⬅️ klik di area aman: jangan tutup

    //   box.classList.add('hidden');
    //   btn?.setAttribute('aria-expanded','false');
    //   document.body.classList.remove('tools-open');

    //   // tutup semua isi tools (admin/live) sesuai kebijakan kamu
    //   hideAllToolsPanels();
    // });

    // // ESC selalu menutup (tetap sama)
    // document.addEventListener('keydown', (e) => {
    //   if (e.key !== 'Escape') return;
    //   const box = document.getElementById('topActions');
    //   const btn = document.getElementById('toggleAsideBtn');
    //   if (!box || box.classList.contains('hidden')) return;

    //   box.classList.add('hidden');
    //   btn?.setAttribute('aria-expanded','false');
    //   document.body.classList.remove('tools-open');
    //   hideAllToolsPanels();
    // });

    function setAkronimHeights(){
      const box = document.getElementById('akronimBox');
      const sc  = document.getElementById('akronimScroll');
      if (!box || !sc) return;

      if (isMobile()){
        // Mobile: tinggi disesuaikan dengan isi akronim saja
        // scroll hanya muncul jika isi lebih tinggi dari viewport
        sc.style.height = 'auto';
        sc.style.maxHeight = (window.innerHeight * 0.5) + 'px'; // batas maksimal 50% layar
      } else {
        // Desktop: biarkan flex mengatur penuh kolom aside; sc mengisi penuh & scroll
        sc.style.height = '';
        sc.style.maxHeight = '';
        sc.style.flex = '1 1 auto';
      }
    }


    // panggil ketika orientasi/resize agar responsif
    window.addEventListener('resize', () => {
      // hanya update jika panel akronim sedang terbuka
      if (!document.getElementById('akronimBox')?.classList.contains('hidden')){
        setAkronimHeights();
        const scroller = document.getElementById('akronimScroll') || document.getElementById('akronimBox');
        attachScrollline?.(scroller, scroller);
        refreshScrolllines?.();
      }
    });


    // ===== Akronim state
    async function fetchAkronim(){
      const res = await fetch('/akronim');
      if (!res.ok) throw new Error('Gagal memuat akronim');

      AKRONIM = await res.json();

      // Urutkan berdasarkan title (nama) secara alfabet
      AKRONIM.sort((a, b) => {
        if (!a.title) return 1;
        if (!b.title) return -1;
        return a.title.localeCompare(b.title, 'id', { sensitivity: 'base' });
      });

      AKRONIM_FILTERED = AKRONIM.slice();
      renderAkronim(AKRONIM_FILTERED);
    }

    let AKRONIM = [];            // cache
    let AKRONIM_FILTERED = [];   // hasil filter akronim

    function renderAkronim(list){
      const tbody = document.getElementById('akronimList');
      const pagWrap = document.getElementById('akrPaginationWrap');
      const isMobile = window.matchMedia('(max-width: 640px)').matches;

      tbody.innerHTML = '';
      if (pagWrap) pagWrap.innerHTML = '';

      if (!list.length){
        tbody.innerHTML = `<tr><td colspan="4" class="py-3 text-gray-500">Belum ada data akronim.</td></tr>`;
        // refresh tinggi & scrollline agar konsisten
        setAkronimHeights?.();
        refreshScrolllines?.();
        return;
      }

      if (isMobile){
        // === MOBILE: pakai pagination agar list pendek
        const { page, totalPages, slice } = paginateMobile(list, akrCurrentPage, PAGE_SIZE_MOBILE_AKR);
        akrCurrentPage = page; // clamp

        slice.forEach(r => {
          const tr = document.createElement('tr');
          tr.className = 'border-t';
          tr.innerHTML = `
            <td class="py-2 pr-2 font-semibold text-gray-800">${r.title || ''}</td>
            <td class="py-2 pr-2 text-gray-700">${r.content || ''}</td>
            <td class="py-2 pr-2">
              ${r.link_url ? `<a class="text-blue-600 hover:underline" target="_blank" href="${r.link_url}">Buka</a>` : ''}
            </td>
            <td class="py-2 text-right">
              ${isAdmin()
                ? `<button class="text-xs rounded-full border px-2 py-0.5 hover:bg-gray-50" data-akr-id="${r.id}" data-akr-act="del">Hapus</button>`
                : ''
              }
            </td>
          `;
          tbody.appendChild(tr);
        });

        renderAkrPaginationMobile(totalPages);
      } else {
        // === DESKTOP/TABLET: tampilkan semua; scroll di dalam #akronimScroll
        list.forEach(r => {
          const tr = document.createElement('tr');
          tr.className = 'border-t';
          tr.innerHTML = `
            <td class="py-2 pr-2 font-semibold text-gray-800">${r.title || ''}</td>
            <td class="py-2 pr-2 text-gray-700">${r.content || ''}</td>
            <td class="py-2 pr-2">
              ${r.link_url ? `<a class="text-blue-600 hover:underline" target="_blank" href="${r.link_url}">Buka</a>` : ''}
            </td>
            <td class="py-2 text-right">
              ${isAdmin()
                ? `<button class="text-xs rounded-full border px-2 py-0.5 hover:bg-gray-50" data-akr-id="${r.id}" data-akr-act="del">Hapus</button>`
                : ''
              }
            </td>
          `;
          tbody.appendChild(tr);
        });
        if (pagWrap) pagWrap.classList.add('hidden'); // jaga2
      }

      // konsistensi tinggi & scrollline panel Akronim
      setAkronimHeights?.();
      const scroller = document.getElementById('akronimScroll') || document.getElementById('akronimBox');
      attachScrollline?.(scroller, scroller);
      refreshScrolllines?.();
    }

    function renderAkrPaginationMobile(totalPages){
      const wrap = document.getElementById('akrPaginationWrap');
      if (!wrap) return;

      wrap.innerHTML = '';
      wrap.classList.remove('hidden');

      if (totalPages <= 1){ wrap.classList.add('hidden'); return; }

      const btn = (label, page, {active=false, disabled=false}={}) => {
        const b = document.createElement('button');
        b.textContent = label;
        b.className = "px-3 py-1 rounded-lg border text-sm " +
                      (active ? "bg-sky-600 text-white border-sky-600" : "hover:bg-gray-50") +
                      (disabled ? " opacity-40 cursor-not-allowed" : "");
        if (!disabled) b.addEventListener('click', () => {
          akrCurrentPage = page;
          renderAkronim(AKRONIM_FILTERED ?? AKRONIM);
        });
        wrap.appendChild(b);
      };

      // Prev
      btn('‹', Math.max(1, akrCurrentPage-1), {disabled: akrCurrentPage===1});

      // Ringkas: 1 … p-1 p p+1 … last (ala compact)
      if (totalPages <= 7){
        for (let i=1;i<=totalPages;i++) btn(String(i), i, {active: i===akrCurrentPage});
      } else {
        btn('1', 1, {active: akrCurrentPage===1});
        if (akrCurrentPage > 3) addDots(wrap);

        const start = Math.max(2, akrCurrentPage - 1);
        const end   = Math.min(totalPages - 1, akrCurrentPage + 1);
        for (let p = start; p <= end; p++) btn(String(p), p, {active: p===akrCurrentPage});

        if (akrCurrentPage < totalPages - 2) addDots(wrap);
        btn(String(totalPages), totalPages, {active: akrCurrentPage===totalPages});
      }

      // Next
      btn('›', Math.min(totalPages, akrCurrentPage+1), {disabled: akrCurrentPage===totalPages});

      function addDots(w){
        const s = document.createElement('span');
        s.textContent = '…';
        s.className = 'px-2 text-gray-500';
        w.appendChild(s);
      }
    }

    async function toggleAkronim(){
      const adminBox = document.getElementById('adminBar');
      const liveBox  = document.getElementById('liveAssistantBox');
      const akrBox   = document.getElementById('akronimBox');

      // tutup hamburger highlight
      document.getElementById('toggleAsideBtn')?.setAttribute('aria-expanded','false');
      document.body.classList.remove('tools-open');

      const willOpen = akrBox.classList.contains('hidden');

      if (willOpen) {
        // buka Akronim, tutup yang lain
        akrBox.classList.remove('hidden');
        if (adminBox && !adminBox.classList.contains('hidden')) adminBox.classList.add('hidden');
        if (liveBox  && !liveBox.classList.contains('hidden'))  liveBox.classList.add('hidden');

        if (isMobile()) {
          mountToolPanel?.(akrBox);
          mountToolPanel?.(adminBox);
          mountToolPanel?.(liveBox);
        } else {
          moveSearchToTopForTools?.();
          ensureAsideVisible?.();
          mountToolPanel?.(akrBox);
        }

        try {
          if (!AKRONIM || AKRONIM.length === 0) await fetchAkronim();
        } catch (err){
          console.error(err);
          const tbody = document.getElementById('akronimList');
          if (tbody){
            tbody.innerHTML = `<tr><td colspan="4" class="py-3 text-rose-600">Gagal memuat. Coba muat ulang.</td></tr>`;
          }
        }
      } else {
        akrBox.classList.add('hidden');
      }

      const adminOpen = adminBox && !adminBox.classList.contains('hidden');
      const liveOpen  = liveBox  && !liveBox.classList.contains('hidden');
      const akrOpen   = !akrBox.classList.contains('hidden');

      setToolsIndicator({
        adminOpen: adminOpen,
        akronimOpen: akrOpen,
        liveOpen : liveOpen
      });

      closeAsideIfEmpty();
      applyAsideLayout?.();
      attachScrollline?.(akrBox, akrBox);
      refreshScrolllines?.();
      setPanelHeights?.();
      restoreSearchPositionIfNeeded?.();
      updateSearchPosition?.();
    }



    document.getElementById('akrFilter')?.addEventListener('input', (e)=>{
      const q = (e.target.value || '').toLowerCase().trim();
      AKRONIM_FILTERED = !q ? AKRONIM.slice()
        : AKRONIM.filter(x => [x.title, x.content].some(t => t?.toLowerCase().includes(q)));
      akrCurrentPage = 1;                // ⬅️ reset ke halaman 1
      renderAkronim(AKRONIM_FILTERED);
    });

    document.getElementById('akrReloadBtn')?.addEventListener('click', ()=>{
      akrCurrentPage = 1;                // ⬅️ reset ke halaman 1
      fetchAkronim().catch(()=>{});
    });

    function ensureAkrValidPage(){
      const totalPages = Math.max(1, Math.ceil((AKRONIM_FILTERED?.length || AKRONIM.length) / PAGE_SIZE_MOBILE_AKR));
      if (akrCurrentPage > totalPages) akrCurrentPage = totalPages;
    }







    // ===== Mobile tools host (menaruh Admin/Live di bawah search saat HP) =====
    function getMobileToolsHost() {
      if (!isMobile()) return null;
      const searchRow  = document.getElementById('searchRow');
      const topActions = document.getElementById('topActions');
      if (!searchRow || !topActions) return null;

      let host = document.getElementById('toolsMobileHost');
      if (!host) {
        host = document.createElement('div');
        host.id = 'toolsMobileHost';
        host.className = 'mt-2 space-y-3'; // biar rapi
      }
      // Pastikan host PERSIS setelah #topActions
      if (host.parentElement !== searchRow || host.previousElementSibling !== topActions) {
        searchRow.insertBefore(host, topActions.nextSibling);
      }
      return host;
    }

    function mountToolPanel(panelEl){
      if (!panelEl) return;
      const aside = document.getElementById('rightAside');

      if (isMobile()) {
        const host = getMobileToolsHost();
        if (host && panelEl.parentElement !== host) host.appendChild(panelEl);
        // aside tetap hidden di HP (kamu sudah punya guardnya)
      } else {
        if (aside && panelEl.parentElement !== aside) aside.appendChild(panelEl);
      }
    }

    // Sinkron mounting & posisi host saat resize/orientasi
    function syncToolsMount(){
      const host = getMobileToolsHost(); // ini juga menjamin posisi host sesudah topActions
      ['adminBar','liveAssistantBox','akronimBox'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) mountToolPanel(el);
      });
    }
    window.addEventListener('resize', syncToolsMount);

    function hideTopActions(){
      const panel = document.getElementById('topActions');
      const btn   = document.getElementById('toggleAsideBtn');
      if (!panel) return;
      panel.classList.add('hidden');
      btn?.setAttribute('aria-expanded','false');
      document.body.classList.remove('tools-open'); // jaga2 desktop
    }

    function toggleAdminBar(force) {
      const adminBox = document.getElementById('adminBar');
      const liveBox  = document.getElementById('liveAssistantBox');
      const akrBox   = document.getElementById('akronimBox');

      const btnAdmin = document.getElementById('btnAdminToggle');

      // tutup highlight hamburger
      document.getElementById('toggleAsideBtn')?.setAttribute('aria-expanded','false');
      document.body.classList.remove('tools-open');

      // akan dibuka?
      const willOpen = (typeof force === 'boolean')
        ? force
        : adminBox.classList.contains('hidden');

      if (willOpen) {
        // buka Admin
        adminBox.classList.remove('hidden');

        // tutup yang lain
        if (liveBox && !liveBox.classList.contains('hidden')) liveBox.classList.add('hidden');
        if (akrBox  && !akrBox.classList.contains('hidden')) akrBox.classList.add('hidden');

        // mount & layout
        if (isMobile()) {
          mountToolPanel?.(adminBox);
          mountToolPanel?.(liveBox);
          mountToolPanel?.(akrBox);
          // topActions di HP biarkan tetap tampil
        } else {
          moveSearchToTopForTools?.();
          ensureAsideVisible?.();
          mountToolPanel?.(adminBox);
        }
      } else {
        // tutup Admin
        adminBox.classList.add('hidden');
      }

      // indikator tombol (konsisten)
      setToolsIndicator({
        adminOpen   : !adminBox.classList.contains('hidden'),
        akronimOpen : akrBox ? !akrBox.classList.contains('hidden') : false,
        liveOpen    : liveBox ? !liveBox.classList.contains('hidden') : false
      });

      closeAsideIfEmpty?.();
      applyAsideLayout?.();
      attachScrollline?.(adminBox, adminBox);
      refreshScrolllines?.();
      setPanelHeights?.();
      restoreSearchPositionIfNeeded?.();
      updateSearchPosition?.();
    }



    function toggleLiveAssistant() {
      const adminBox = document.getElementById('adminBar');
      const liveBox  = document.getElementById('liveAssistantBox');
      const akrBox   = document.getElementById('akronimBox');

      // tutup highlight hamburger
      document.getElementById('toggleAsideBtn')?.setAttribute('aria-expanded','false');
      document.body.classList.remove('tools-open');

      const willOpen = liveBox.classList.contains('hidden');

      if (willOpen) {
        // buka Live
        liveBox.classList.remove('hidden');

        // tutup yang lain
        if (adminBox && !adminBox.classList.contains('hidden')) adminBox.classList.add('hidden');
        if (akrBox  && !akrBox.classList.contains('hidden')) akrBox.classList.add('hidden');

        // mount & layout
        if (isMobile()) {
          mountToolPanel?.(liveBox);
          mountToolPanel?.(adminBox);
          mountToolPanel?.(akrBox);
        } else {
          moveSearchToTopForTools?.();
          ensureAsideVisible?.();
          mountToolPanel?.(liveBox);
        }
      } else {
        // tutup Live
        liveBox.classList.add('hidden');
      }

      // indikator tombol (konsisten)
      setToolsIndicator({
        adminOpen   : adminBox ? !adminBox.classList.contains('hidden') : false,
        akronimOpen : akrBox ? !akrBox.classList.contains('hidden') : false,
        liveOpen    : !liveBox.classList.contains('hidden')
      });

      closeAsideIfEmpty?.();
      applyAsideLayout?.();
      attachScrollline?.(liveBox, liveBox);
      refreshScrolllines?.();
      setPanelHeights?.();
      restoreSearchPositionIfNeeded?.();
      updateSearchPosition?.();
    }




    // ===== Events =====
    searchForm.addEventListener('submit', doSearch);
    searchInput.addEventListener('input', (e) => {
      clearBtn.classList.toggle('hidden', !e.target.value.length);

      // kalau kosong
      if (!e.target.value.trim()){
        // ⬇️ ganti: JANGAN turun ke landing kalau tools terbuka
        if (isToolsOpen()){
          // tetap di atas, tapi sembunyikan panel hasil
          updateSearchPosition();
          resultsWrap.classList.add('hidden');
          detailWrap.classList.add('hidden');
        } else {
          showLanding();  // perilaku lama
        }
        return;
      }

      // kalau sudah pernah search → langsung filter & naikkan hero
      if (searched){
        applyFilter();
        renderResultsUI();
        renderDetail(FILTERED[0] || null);
        showSearch();
      }
    });


    clearBtn.addEventListener('click', () => {
      // kosongkan input & tombol clear disembunyikan
      searchInput.value = '';
      clearBtn.classList.add('hidden');

      // Selalu reset hasil & halaman
      FILTERED = [];
      currentPage = 1;

      // Kunci: kalau tools (Admin/Live) sedang terbuka → tetap di ATAS
      if (typeof isToolsOpen === 'function' && isToolsOpen()) {
        // tetap mode search di atas, tapi sembunyikan panel hasil
        setHeroCollapsed(true);
        document.body.classList.add('search-mode');
        resultsWrap.classList.add('hidden');
        detailWrap.classList.add('hidden');

        // bersihkan URL query tanpa memicu render ulang
        const params = stateToParams({ q: '', page: 1 });
        replaceRoute(params);
      } else {
        // normal: kembali ke landing (search di tengah)
        showLanding();
      }

      // rapikan UI
      resultsList.innerHTML = '';
      if (typeof refreshScrolllines === 'function') refreshScrolllines();
      if (typeof setPanelHeights === 'function') setPanelHeights();
    });


    resultsList.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-id]');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const type = btn.getAttribute('data-type');
      const item = FILTERED.find(x => String(x.id) === String(id) && x.type === type)
                    || ITEMS.find(x => String(x.id) === String(id) && x.type === type);
      renderDetail(item);
      const params = stateToParams({ q: searchInput.value.trim(), page: currentPage, id: item.id, type: item.type });
      pushRoute(params);
    });

    resultsList.addEventListener('keydown', (e) => {
      const buttons = Array.from(resultsList.querySelectorAll('button[data-id]'));
      if (!buttons.length) return;
      if (['ArrowDown','ArrowUp','Enter'].includes(e.key)) e.preventDefault();
      if (e.key === 'ArrowDown') {
        activeIndex = Math.min(buttons.length-1, activeIndex + 1);
        buttons[activeIndex].focus();
      } else if (e.key === 'ArrowUp') {
        activeIndex = Math.max(0, activeIndex - 1);
        buttons[activeIndex].focus();
      } else if (e.key === 'Enter' && activeIndex >= 0) {
        buttons[activeIndex].click();
      }
    });

    // ===== Admin: Tambah FAQ / Glosarium =====
    document.getElementById('faqAddBtn')?.addEventListener('click', async () => {
      const title = (document.getElementById('faqTitle').value || '').trim();
      const content = (document.getElementById('faqContent').value || '').trim();
      const image_url = (document.getElementById('faqImageUrl').value || '').trim();
      const link_url  = (document.getElementById('faqUrlLink').value || '').trim();
      if (!title || !content) return alert('Isi pertanyaan & jawaban');

      try {
        const res = await fetch('/faq', {
          method:'POST',
          headers: headersJSON(),
          body: JSON.stringify({ title, content, image_url, link_url })
        });
        if (!res.ok) throw new Error((await res.json()).error || 'Gagal menambah FAQ');

        // reset form
        document.getElementById('faqTitle').value = '';
        document.getElementById('faqContent').value = '';
        document.getElementById('faqImageUrl').value = '';
        document.getElementById('faqUrlLink').value  = '';
        await doSearch();
      } catch (e) { alert(e.message); }
    });

    document.getElementById('gloAddBtn')?.addEventListener('click', async () => {
      const title = (document.getElementById('gloTitle').value || '').trim();
      const content = (document.getElementById('gloContent').value || '').trim();
      const image_url = (document.getElementById('gloImageUrl').value || '').trim();
      const link_url  = (document.getElementById('gloUrlLink').value || '').trim();
      if (!title || !content) return alert('Isi istilah & definisi');
      try {
        const res = await fetch('/glossary', {
          method:'POST',
          headers: headersJSON(),
          body: JSON.stringify({ title, content, image_url, link_url })
        });
        if (!res.ok) throw new Error((await res.json()).error || 'Gagal menambah glosarium');
        document.getElementById('gloTitle').value = '';
        document.getElementById('gloContent').value = '';
        document.getElementById('gloImageUrl').value = '';
        document.getElementById('gloUrlLink').value = '';
        await doSearch();
      } catch (e) { alert(e.message); }
    });


    // ===== Admin: Edit/Hapus di panel detail (INLINE) =====
    detailEditBtn.addEventListener('click', () => {
      if (!activeItem) return;
      editTitle.value = activeItem.title || '';
      editContent.value = activeItem.content || '';
      editImageUrl.value = activeItem.image_url || '';
      document.getElementById('editUrlLink').value = activeItem.link_url || ''; // ← isi url link
      detailView.classList.add('hidden');
      detailEditForm.classList.remove('hidden');
    });
    detailCancelBtn.addEventListener('click', () => {
      detailEditForm.classList.add('hidden');
      detailView.classList.remove('hidden');
    });

    detailEditForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!activeItem) return;
      const newTitle = editTitle.value.trim();
      const newContent = editContent.value.trim();
      const newImage = (editImageUrl.value || '').trim();
      const newUrl   = (document.getElementById('editUrlLink').value || '').trim();
      if (!newTitle || !newContent) return alert('Judul & Konten wajib diisi');
      try {
        const url = `/${activeItem.type}/${activeItem.id}`;
        const res = await fetch(url, {
          method:'PUT',
          headers: headersJSON(),
          body: JSON.stringify({ title: newTitle, content: newContent, image_url: newImage, link_url: newUrl })
        });
        if (!res.ok) throw new Error((await res.json()).error || 'Gagal menyimpan perubahan');
        await doSearch();
        detailEditForm.classList.add('hidden');
        detailView.classList.remove('hidden');
      } catch (e) { alert(e.message); }
    });

    detailDeleteBtn.addEventListener('click', async () => {
      if (!activeItem) return;
      if (!confirm('Yakin hapus entri ini?')) return;
      try {
        const url = `/${activeItem.type}/${activeItem.id}`;
        const res = await fetch(url, { method:'DELETE', headers: headersJSON() });
        if (!res.ok) throw new Error((await res.json()).error || 'Gagal menghapus');
        activeItem = null;
        await doSearch();
        if (!FILTERED.length) {
          detailTitle.textContent = '';
          detailBody.textContent = '';
          detailCat.textContent = '';
        }
      } catch (e) { alert(e.message); }
    });

    function sendToEmail() {
      const subject = document.getElementById("assistantSubject").value.trim();
      const message = document.getElementById("assistantMsg").value.trim();

      if (!subject && !message) {
        alert("Isi subjek atau pesan terlebih dahulu.");
        return;
      }

      const email = "rashadfajar@gmail.com"; // ganti dengan alamat email tujuan
      const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
      window.location.href = mailtoLink;
    }

    // tambah
    document.getElementById('akrAddBtn')?.addEventListener('click', async ()=>{
      const title = (document.getElementById('akrTitle').value || '').trim();
      const content = (document.getElementById('akrContent').value || '').trim();
      const link_url = (document.getElementById('akrUrlLink').value || '').trim();
      if (!title || !content) return alert('Isi singkatan & penjelasan');

      try {
        const res = await fetch('/akronim', {
          method: 'POST',
          headers: headersJSON(),
          body: JSON.stringify({ title, content, link_url })
        });
        if (!res.ok) throw new Error((await res.json()).error || 'Gagal menambah akronim');
        // reset
        document.getElementById('akrTitle').value = '';
        document.getElementById('akrContent').value = '';
        document.getElementById('akrUrlLink').value = '';
        await fetchAkronim();
        // auto tampilkan panel Akronim biar terlihat hasilnya
        const boxAkr  = document.getElementById('akronimBox');
        const btnAkr  = document.getElementById('btnAkronimToggle');
        if (boxAkr.classList.contains('hidden')) { boxAkr.classList.remove('hidden'); btnAkr?.classList.add('text-sky-700'); }
      } catch (e){ alert(e.message); }
    });

    // hapus (delegation di tbody)
    document.getElementById('akronimList')?.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-akr-id][data-akr-act="del"]');
      if (!btn) return;
      const id = btn.getAttribute('data-akr-id');
      if (!confirm('Hapus akronim ini?')) return;
      try {
        const res = await fetch(`/akronim/${id}`, { method:'DELETE', headers: headersJSON() });
        if (!res.ok) throw new Error((await res.json()).error || 'Gagal menghapus');
        await fetchAkronim();
      } catch (err){ alert(err.message); }

      ensureAkrValidPage(); renderAkronim(AKRONIM_FILTERED);
    });



    // ===== Salin tautan detail =====
    copyLinkBtn?.addEventListener('click', async () => {
      if (!activeItem) return;
      const params = stateToParams({ q: searchInput.value.trim(), page: currentPage, id: activeItem.id, type: activeItem.type });
      const url = `${location.origin}${location.pathname}?${params}`;
      try {
        await navigator.clipboard.writeText(url);
        copyLinkStatus.classList.remove('hidden');
        setTimeout(()=>copyLinkStatus.classList.add('hidden'), 1200);
      } catch (e){ alert(url); }
    });

    // === Scroll Line Utility with DRAG & CLICK (fixed) ===
    const SCROLLLINE_GAP = 8;          // gap default atas/bawah
    const SCROLLLINE_OFFSET_Y = 15;    // geser sedikit turun

    function attachScrollline(scroller, hostForLine, opts = {}) {
      if (!scroller) return;

      // opsi per-instance (bisa diubah saat memanggil)
      const defaults = {
        gapTop: SCROLLLINE_GAP + SCROLLLINE_OFFSET_Y, // turun sedikit
        gapBottom: SCROLLLINE_GAP,                    // atur lebih kecil utk "rentang bawah" lebih jauh
        right: 8,
        width: null                                   // set angka (mis. 20) kalau mau override CSS
      };
      const options = { ...defaults, ...(scroller._scrollline?.opts || {}), ...opts };

      // buat elemen sekali saja
      if (!scroller._scrollline) {
        const host = hostForLine || scroller.parentElement || scroller;
        if (!host) return;
        if (getComputedStyle(host).position === 'static') host.style.position = 'relative';

        const track = document.createElement('div');
        track.className = 'scrollline';
        const thumb = document.createElement('div');
        thumb.className = 'scrollline__thumb';
        track.appendChild(thumb);
        host.appendChild(track);

        scroller._scrollline = { host, track, thumb, opts: options };
        scroller.dataset.scrolllineAttached = '1';

        scroller.addEventListener('scroll', update, { passive: true });
        new ResizeObserver(update).observe(scroller);
        window.addEventListener('resize', update);

        // DRAG setup
        let dragging = false;
        let startClientY = 0, startThumbTop = 0;

        const onMove = (ev) => {
          if (!dragging) return;
          ev.preventDefault();
          const clientY = ev.touches ? ev.touches[0].clientY : ev.clientY;
          const m = metrics();
          const delta = clientY - startClientY;
          const newThumbTop = Math.max(0, Math.min(m.maxThumbTop, startThumbTop + delta));
          const scrollRatio = m.maxThumbTop > 0 ? (newThumbTop / m.maxThumbTop) : 0;
          scroller.scrollTop = Math.round(m.scrollable * scrollRatio);
        };

        const stopDrag = () => {
          if (!dragging) return;
          dragging = false;
          thumb.classList.remove('dragging');
          scroller.classList.remove('no-select');
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', stopDrag);
          document.removeEventListener('touchmove', onMove, { passive:false });
          document.removeEventListener('touchend', stopDrag);
        };

        const startDrag = (ev) => {
          ev.preventDefault();
          dragging = true;
          thumb.classList.add('dragging');
          scroller.classList.add('no-select');
          startClientY = ev.touches ? ev.touches[0].clientY : ev.clientY;
          startThumbTop = parseFloat(getComputedStyle(thumb).top) || 0;
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', stopDrag);
          document.addEventListener('touchmove', onMove, { passive:false });
          document.addEventListener('touchend', stopDrag);
        };

        thumb.addEventListener('mousedown', startDrag);
        thumb.addEventListener('touchstart', startDrag, { passive:false });

        // CLICK track (lompat)
        track.addEventListener('mousedown', (e) => {
          if (e.target === thumb) return;
          const rect = track.getBoundingClientRect();
          const y = e.clientY - rect.top;
          const m = metrics();
          const ratio = Math.max(0, Math.min(1, y / m.trackH));
          scroller.scrollTop = Math.round(m.scrollable * ratio);
        });
      } else {
        // update opsi kalau sudah terpasang
        scroller._scrollline.opts = options;
      }

      // ---- helpers konsisten ----
      function metrics() {
        const { host, opts } = scroller._scrollline;
        const h  = scroller.clientHeight;
        const sh = scroller.scrollHeight;
        const st = scroller.scrollTop;
        const hasScroll = sh > h + 1;

        const trackH  = Math.max(24, h - (opts.gapTop + opts.gapBottom));
        const baseTop = (host === scroller ? st : 0) + opts.gapTop;
        const ratio   = h / sh;
        const thumbH  = Math.max(30, Math.round(trackH * ratio));
        const maxThumbTop = Math.max(0, trackH - thumbH);
        const scrollable  = Math.max(0, sh - h);

        return { h, sh, st, hasScroll, trackH, baseTop, ratio, thumbH, maxThumbTop, scrollable };
      }

      function update() {
        const { track, thumb, opts } = scroller._scrollline;
        const m = metrics();

        track.style.display = m.hasScroll ? 'block' : 'none';
        if (!m.hasScroll) return;

        if (opts.width != null) track.style.width = opts.width + 'px';
        track.style.right  = (opts.right ?? 8) + 'px';
        track.style.top    = m.baseTop + 'px';
        track.style.height = m.trackH + 'px';

        const thumbTop = m.scrollable ? Math.round((m.st / m.scrollable) * m.maxThumbTop) : 0;
        thumb.style.height = m.thumbH + 'px';
        thumb.style.top    = Math.max(0, Math.min(m.maxThumbTop, thumbTop)) + 'px';
      }

      // render awal + expose updater
      requestAnimationFrame(update);
      scroller._updateScrollline = update;
    }

    function refreshScrolllines() {
      ['resultsList','detailWrap','adminBar','liveAssistantBox']
        .map(id => document.getElementById(id))
        .forEach(el => el?._updateScrollline && el._updateScrollline());
    }


    // ===== Router: back/forward & boot from URL =====
    window.addEventListener('popstate', async () => {
      const { q, /* page, */ id, type } = readRoute();
      if (!ITEMS.length) await fetchData();

      searchInput.value = q || '';
      clearBtn.classList.toggle('hidden', !q);

      if (!q) {                 // kembali ke landing
        showLanding();
        renderDetail(null);
        refreshScrolllines();   // <-- update garis
        return;
      }

      // mode search
      searched = true;
      showSearch();
      showResultsUI();

      applyFilter();
      // currentPage = page || 1;
      renderResultsUI();

      if (id && type){
        const item = FILTERED.find(x=>String(x.id)===String(id) && x.type===type)
                || ITEMS.find(x=>String(x.id)===String(id) && x.type===type);
        if (item) renderDetail(item);
      } else {
        renderDetail(FILTERED[0] || null);
      }
      refreshScrolllines();     // <-- update garis setelah render
      updateSearchPosition();
    });

    // Boot: baca URL params kalau ada
    (async function boot(){
      const { q,  /* page, */ id, type } = readRoute();
      if (!ITEMS.length) await fetchData();
      const isMobile = window.matchMedia('(max-width: 640px)').matches;

      if (!q) {
        showLanding();
        renderAdminState();

        /* kiri */
        attachScrollline(
          document.getElementById('resultsList'),
          null,
          isMobile ? { gapTop: 36, gapBottom: 4, width: 12 } : { gapTop: 50, gapBottom: -30 }
        );

        /* tengah & kanan */
        attachScrollline(
          document.getElementById('detailWrap'),
          document.getElementById('middleCol'),
          isMobile ? { width: 12 } : {}
        );
        attachScrollline(
          document.getElementById('adminBar'),
          document.getElementById('rightAside'),
          isMobile ? { width: 12 } : {}
        );
        attachScrollline(
          document.getElementById('liveAssistantBox'),
          document.getElementById('rightAside'),
          isMobile ? { width: 12 } : {}
        );

        refreshScrolllines();
        setPanelHeights();
        return;
      }

      // ada q → langsung mode search
      searchInput.value = q;
      clearBtn.classList.remove('hidden');
      searched = true;

      showSearch();
      showResultsUI();

      applyFilter();
      // currentPage = page || 1;
      renderResultsUI();

      if (id && type){
        const item = ITEMS.find(x=>String(x.id)===String(id) && x.type===type);
        if (item){ renderDetail(item); }
      } else {
        renderDetail(FILTERED[0] || null);
      }

      replaceRoute(stateToParams({ q: searchInput.value.trim(), page: currentPage, id, type }));
      renderAdminState();

      /* kiri */
      attachScrollline(
        document.getElementById('resultsList'),
        null,
        isMobile ? { gapTop: 36, gapBottom: 4, width: 12 } : { gapTop: 50, gapBottom: -30 }
      );

      /* tengah & kanan */
      attachScrollline(
        document.getElementById('detailWrap'),
        document.getElementById('middleCol'),
        isMobile ? { width: 12 } : {}
      );
      attachScrollline(
        document.getElementById('adminBar'),
        document.getElementById('rightAside'),
        isMobile ? { width: 12 } : {}
      );
      attachScrollline(
        document.getElementById('liveAssistantBox'),
        document.getElementById('rightAside'),
        isMobile ? { width: 12 } : {}
      );
      refreshScrolllines();
      setPanelHeights();
      updateSearchPosition();
    })();

    applyAsideLayout();
    
  </script>
</body>
</html>
