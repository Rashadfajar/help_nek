<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pusat Bantuan Penyelenggaraan NEK Provinsi DKI Jakarta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen">
  <div class="max-w-6xl mx-auto px-4 md:px-6 py-8 md:py-10">
    <!-- Header -->
    <div id="logoTitle" class="mb-10 flex flex-col items-center md:flex-row md:justify-center md:space-x-4">
      <img  src="assets/logo_jakarta.png" alt="Logo DKI Jakarta" class="h-16 md:h-20 mb-2 md:mb-0">
      <div class="text-center md:text-left">
        <h1 class="text-3xl md:text-4xl font-bold tracking-tight text-green-700">Pusat Bantuan</h1>
        <h2 class="text-2xl font-semibold tracking-tight text-green-700">Penyelenggaraan NEK Provinsi DKI Jakarta</h2>
      </div>
    </div>

    <!-- Deskripsi singkat
    <p class="text-center text-gray-600 mb-4">
      Pusat bantuan adalah tempat untuk mencari jawaban atas pertanyaan seputar NEK (Nilai Ekonomi Karbon).
    </p> -->

    <!-- Search -->
    <div class="relative mb-4 max-w-4xl mx-auto">
      <div class="flex gap-2 items-stretch">
        <!-- Form pencarian -->
        <form id="searchForm" class="flex flex-grow items-center gap-2 rounded-2xl border bg-white px-3 shadow-sm">
          <input
            type="text"
            id="searchInput"
            placeholder="Cari bantuan… (mis. PTBAE-PU, SRN-PPI, ETS)"
            class="h-12 w-full outline-none"
          />
          <button id="clearBtn" type="button" title="Bersihkan" class="hidden rounded-xl px-2 py-1 text-sm text-gray-500 hover:bg-gray-100">✕</button>
            <!-- <button type="submit" class="h-11 rounded-xl bg-emerald-600 px-4 text-sm text-white hover:bg-emerald-700">
              Cari
            </button> -->
        </form>

        <!-- Tombol toggle aside dengan ikon -->
        <button onclick="toggleAside()" class="h-12 aspect-square rounded-xl bg-green-600 p-2 text-white hover:bg-yellow-500" title="Buka Bantuan">
          <!-- Icon Hamburger -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>



    <!-- Grid Utama -->
    <main  class="flex-grow grid grid-cols-1 md:grid-cols-12 gap-4">
      <!-- Kiri: Hasil Pencarian + Pagination -->
      <section id="leftCol" class="order-2 md:order-1 md:col-span-3">
        <div id="resultsWrap" class="hidden rounded-2xl border bg-white p-2 shadow-sm">
          <div id="resultsMeta" class="px-3 py-2 text-sm text-gray-500"></div>
          <ul id="resultsList" class="divide-y" tabindex="0" aria-label="Daftar hasil"></ul>
          <!-- Pagination (compact) -->
          <div id="paginationWrap" class="hidden px-3 py-3 border-t flex items-center justify-center gap-1"></div>
        </div>
      </section>

      <!-- Tengah: Detail -->
      <section id="middleCol" class="order-3 md:order-2 md:col-span-5">
        <div id="detailWrap" class="hidden rounded-2xl border bg-white p-6 shadow-sm">
          <div class="mb-2 flex items-start justify-between gap-3">
            <div class="flex items-center gap-2">
              <span id="detailCat" class="rounded-full border px-2 py-0.5 text-xs text-gray-600"></span>
            </div>
            <div id="detailActions" class="hidden shrink-0 space-x-2">
              <button id="detailEditBtn" class="px-3 py-1.5 text-xs rounded-full border border-violet-200 text-violet-700 hover:bg-violet-50">Edit</button>
              <button id="detailDeleteBtn" class="px-3 py-1.5 text-xs rounded-full border border-rose-200 text-rose-700 hover:bg-rose-50">Hapus</button>
            </div>
          </div>

          <!-- View mode -->
          <div id="detailView">
            <h1 id="detailTitle" class="text-2xl font-semibold"></h1>
            <p id="detailBody" class="mt-3 text-gray-700"></p>

            <!-- 🔽 Tambahan: gambar FAQ -->
            <img id="detailImage" class="mt-4 hidden rounded-xl border border-gray-200 shadow-sm max-h-64 object-contain"
                alt="Gambar FAQ">

            <div id="detailLinksWrap" class="mt-6 space-y-2 hidden">
              <!-- <div class="text-sm font-semibold text-gray-700">Tautan terkait</div> -->
              <button id="detailLinks" class="text-xs rounded-full border px-3 py-1 hover:bg-gray-100"></button>
              <!-- <ul id="detailLinks" class="list-inside list-disc text-sm text-emerald-700"></ul> -->
            </div>
            <!-- <div class="mt-4 flex items-center gap-2">
              <button id="copyLinkBtn" class="text-xs rounded-full border px-3 py-1 hover:bg-gray-50">Salin tautan</button>
              <span id="copyLinkStatus" class="text-xs text-emerald-700 hidden">Tautan disalin</span>
            </div> -->
          </div>

          <!-- Inline edit mode (admin) -->
          <form id="detailEditForm" class="hidden mt-2 space-y-3">
            <input id="editTitle" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500" />
            <textarea id="editContent" rows="6" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500"></textarea>
              <p class="mb-3 text-xs text-gray-500">
                Tambah gambar langsung di konten dengan format:  
                <code>&lt;img src="URL_GAMBAR" alt="deskripsi"&gt;</code>
              </p>

            <input id="editUrlLink" type="url"
              class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500"
              placeholder="URL Link (opsional)">


            <!-- 🔽 Tambahan: URL Gambar -->
            <input id="editImageUrl" type="url"
                  class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500"
                  placeholder="Image URL (opsional)">

            <div class="flex items-center gap-2">
              <button id="detailSaveBtn" class="px-3 py-2 text-sm rounded-lg bg-violet-600 text-white hover:bg-violet-700" type="submit">Simpan</button>
              <button id="detailCancelBtn" class="px-3 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300" type="button">Batal</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Kanan: Tambahkan Informasi + Assistance -->
      <aside id="rightAside" class="hidden order-1 md:order-3 md:col-span-4 space-y-4">
        <!-- Toggle panel admin -->
        <button
          onclick="toggleAdminBar()"
          title="Mode Admin"
          class="rounded-2xl border bg-white px-5 py-2 shadow-sm ml-auto text-xl hover:text-green-700 md:ml-6">
          +Tambah Informasi
        </button>

        <!-- Admin Bar (tersembunyi di awal) -->
        <div id="adminBar" class="hidden mb-8 p-4 bg-violet-50 border border-violet-200 rounded-xl">
          <div class="flex flex-wrap items-center gap-3">
            <!-- ROW input + eye dibungkus satu wrapper agar mudah di-hide -->
            <div id="adminKeyRow" class="relative flex-1 min-w-[220px] max-w-full">
              <input
                id="adminKeyInput"
                type="password"
                placeholder="Masukkan Admin Key"
                class="w-full p-2 pr-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500"
                aria-label="Admin key"
              />
              <button
                type="button"
                id="togglePwdBtn"
                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                title="Lihat/Sembunyikan password"
                aria-label="Lihat atau sembunyikan password">
                <!-- ikon mata -->
                <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
              </button>
            </div>

            <button id="adminLoginBtn"
                    class="px-3 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700">
              Login
            </button>

            <button id="adminLogoutBtn"
                    class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 hidden">
              Logout
            </button>

            <span id="adminStatus" class="text-sm text-gray-700"></span>
          </div>

          <!-- Admin Forms -->
          <div id="adminForms" class="hidden mt-4 grid gap-4">
            <!-- Tambah FAQ -->
            <div class="bg-white p-4 border rounded-xl shadow-sm w-full">
              <h3 class="font-semibold mb-3 text-violet-700">Tambah FAQ</h3>

              <input id="faqTitle"
                    class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                    placeholder="Pertanyaan (title)" />

              <textarea id="faqContent" rows="4"
                        class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                        placeholder="Jawaban (content)"></textarea>

              <input id="faqImageUrl" type="url"
                    class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-violet-500"
                    placeholder="Image URL (opsional)" />

              <input id="faqUrlLink" type="url"
                    class="w-full p-2 border rounded mb-3 focus:outline-none focus:ring-2 focus:ring-violet-500"
                    placeholder="URL Link (opsional)" />

              <p class="mb-3 text-xs text-gray-500">
                Drive direct: https://lh3.googleusercontent.com/d/FILE_ID=w1200
              </p>

              <button id="faqAddBtn"
                      class="w-full px-3 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700">
                Tambah FAQ
              </button>
            </div>

            <!-- Tambah Glosarium -->
            <div class="bg-white p-4 border rounded-xl shadow-sm w-full">
              <h3 class="font-semibold mb-3 text-green-700">Tambah Glosarium</h3>

              <input id="gloTitle"
                    class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                    placeholder="Istilah (title)" />

              <textarea id="gloContent" rows="4"
                        class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                        placeholder="Definisi (content)"></textarea>

              <input id="gloImageUrl" type="url"
                    class="w-full p-2 border rounded mb-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                    placeholder="Image URL (opsional)" />

              <input id="gloUrlLink" type="url"
                    class="w-full p-2 border rounded mb-3 focus:outline-none focus:ring-2 focus:ring-green-500"
                    placeholder="URL Link (opsional)" />

              <p class="mb-3 text-xs text-gray-500">
                Drive direct: https://lh3.googleusercontent.com/d/FILE_ID=w1200
              </p>

              <button id="gloAddBtn"
                      class="w-full px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                Tambah Istilah
              </button>
            </div>
          </div>
        </div>


        <!-- Tombol Live Assistance -->
        <button onclick="toggleLiveAssistant()"
                class="rounded-2xl border bg-white px-5 py-2 shadow-sm ml-auto text-xl hover:text-green-700 md:ml-6">
          Live Assistance
        </button>

        <!-- Kotak Live Assistance -->
        <div id="liveAssistantBox" class="hidden mt-4 rounded-2xl border bg-violet-50 p-5 shadow-sm">
          <h3 class="text-lg font-semibold">Live Assistance via Email</h3>
          <p class="mt-1 text-sm text-gray-600">Butuh bantuan? Kirim pertanyaan Anda melalui email.</p>
          <input id="assistantSubject" placeholder="Subjek email"
                class="mt-3 w-full rounded-xl border px-3 py-2 outline-none" />
          <textarea id="assistantMsg" placeholder="Tulis pesan Anda…"
                    rows="6" class="mt-3 w-full rounded-xl border px-3 py-2 outline-none"></textarea>
          <button onclick="sendToEmail()"
                  class="mt-3 w-full rounded-xl bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">
            Kirim via Email
          </button>
        </div>
      </aside>
    </main>

    <!-- Footer Logo
    <footer class="mt-10 border-t bg-white/50 py-4">
      <div class="mx-auto flex max-w-6xl items-center justify-center gap-6">
        <img src="assets/logo_jakarta.png" alt="Logo DKI Jakarta" class="h-12" />
      </div>
    </footer> -->
  </div>

  <script>
    // ===== Admin toggle =====
    const adminBar = document.getElementById('adminBar');
    const adminKeyInput = document.getElementById('adminKeyInput');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const adminStatus = document.getElementById('adminStatus');
    const adminForms = document.getElementById('adminForms');
    const adminKeyRow  = document.getElementById('adminKeyRow');
    const togglePwdBtn = document.getElementById('togglePwdBtn');
    const adminKeyInputEl = document.getElementById('adminKeyInput');

    // toggle show/hide password
    togglePwdBtn?.addEventListener('click', () => {
      const showing = adminKeyInputEl.type === 'text';
      adminKeyInputEl.type = showing ? 'password' : 'text';
      document.getElementById('eyeIcon')?.classList.toggle('opacity-60', !showing);
    });

    let adminKey = localStorage.getItem('adminKey') || null;
    const isAdmin = () => !!adminKey;

    function setAdminKey(key) {
      adminKey = key || null;
      if (key) localStorage.setItem('adminKey', key);
      else localStorage.removeItem('adminKey');
      renderAdminState();
    }

    function renderAdminState() {
      const detailActions = document.getElementById('detailActions');

      if (isAdmin()) {
        // sembunyikan input + eye + tombol login
        adminKeyRow?.classList.add('hidden');
        adminLoginBtn?.classList.add('hidden');
        adminLogoutBtn?.classList.remove('hidden');
        adminStatus.textContent = 'Mode Admin aktif';

        adminForms?.classList.remove('hidden');
        adminKeyInputEl.value = '';               // bersihkan input
        adminKeyInputEl.type  = 'password';       // reset type
        detailActions?.classList.remove('hidden');
      } else {
        adminKeyRow?.classList.remove('hidden');
        adminLoginBtn?.classList.remove('hidden');
        adminLogoutBtn?.classList.add('hidden');
        adminStatus.textContent = '';

        adminForms?.classList.add('hidden');
        detailActions?.classList.add('hidden');
      }
    }

    // validasi admin key ke server (gunakan header x-admin-key)
    adminLoginBtn?.addEventListener('click', async () => {
      const key = adminKeyInputEl.value.trim();
      if (!key) return alert('Masukkan admin key');

      try {
        const res = await fetch('/health', { headers: { 'x-admin-key': key } });
        if (res.status === 401) {
          alert('Admin key salah');
          return;
        }
        setAdminKey(key); // hanya set jika server tidak 401
      } catch (e) {
        alert('Gagal konek ke server');
      }
    });

    adminLogoutBtn?.addEventListener('click', () => {
      setAdminKey(null);
      // ✅ reset tampilan input password
      adminKeyInputEl.type = 'password';
      document.getElementById('eyeIcon')?.classList.remove('opacity-60');
    });



    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.altKey && (e.key === 'a' || e.key === 'A')) {
        e.preventDefault();
        toggleAdminBar();
      }
    });
    if (new URLSearchParams(location.search).get('admin') === '1') toggleAdminBar(true);


    const headersJSON = () => {
      const h = { 'Content-Type': 'application/json' };
      if (isAdmin()) h['x-admin-key'] = adminKey;
      return h;
    };

    // ===== Elements =====
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');

    const resultsWrap = document.getElementById('resultsWrap');
    const resultsMeta = document.getElementById('resultsMeta');
    const resultsList = document.getElementById('resultsList');
    const paginationWrap = document.getElementById('paginationWrap');

    const detailWrap = document.getElementById('detailWrap');
    const detailCat = document.getElementById('detailCat');
    const detailTitle = document.getElementById('detailTitle');
    const detailBody = document.getElementById('detailBody');
    const detailLinksWrap = document.getElementById('detailLinksWrap');
    const detailLinks = document.getElementById('detailLinks');
    const detailEditBtn = document.getElementById('detailEditBtn');
    const detailDeleteBtn = document.getElementById('detailDeleteBtn');
    const detailEditForm = document.getElementById('detailEditForm');
    const detailView = document.getElementById('detailView');
    const editTitle = document.getElementById('editTitle');
    const editContent = document.getElementById('editContent');
    const detailSaveBtn = document.getElementById('detailSaveBtn');
    const detailCancelBtn = document.getElementById('detailCancelBtn');
    const detailImage = document.getElementById('detailImage');
    const editImageUrl = document.getElementById('editImageUrl');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const copyLinkStatus = document.getElementById('copyLinkStatus');

    const contribForm = document.getElementById('contribForm');
    const contribTitle = document.getElementById('contribTitle');
    const contribBody = document.getElementById('contribBody');
    const contribSrc = document.getElementById('contribSrc');
    const contribStatus = document.getElementById('contribStatus');

    const assistantMsg = document.getElementById('assistantMsg');
    // const assistantSend = document.getElementById('assistantSend');
    // const assistantStatus = document.getElementById('assistantStatus');

    // ===== State =====
    let searched = false;
    let ITEMS = [];        // gabungan FAQ + Glosarium
    let FILTERED = [];     // hasil filter
    let currentPage = 1;   // halaman aktif
    const PAGE_SIZE = 5;   // LIMIT 5 / halaman
    let activeItem = null; // item aktif di detail
    let activeIndex = -1;  // untuk keyboard nav

    // ===== Router Helpers (deep-link) =====
    function stateToParams({q, page, id, type}) {
      const sp = new URLSearchParams(location.search);
      if (q != null) sp.set('q', q); else sp.delete('q');
      if (page) sp.set('p', String(page)); else sp.delete('p');
      if (id && type) { sp.set('id', id); sp.set('t', type); } else { sp.delete('id'); sp.delete('t'); }
      return sp.toString();
    }
    function pushRoute(params){ history.pushState(null, '', `${location.pathname}?${params}${location.hash}`); }
    function replaceRoute(params){ history.replaceState(null, '', `${location.pathname}?${params}${location.hash}`); }
    function readRoute(){
      const sp = new URLSearchParams(location.search);
      return { q: sp.get('q') || '', page: parseInt(sp.get('p')||'1',10) || 1, id: sp.get('id') || null, type: sp.get('t') || null };
    }

    // ===== Helpers =====
    function escapeHtml(s=''){return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
    function highlight(text='', query=''){
      if(!query) return escapeHtml(text);
      const q = query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      return escapeHtml(text).replace(new RegExp(`(${q})`,'gi'),'<mark class="bg-yellow-200 px-0.5 rounded">$1</mark>');
    }

    function normalizeImageUrl(u){
      if(!u) return null;
      const s = u.trim();
      // convert viewer link gdrive -> direct
      const m = s.match(/drive\.google\.com\/file\/d\/([^/]+)/);
      if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;
      // allow relative (assets/xxx.png)
      if(!/^https?:\/\//i.test(s) && !s.startsWith('/')) return `/assets/${s}`;
      return s;
    }

    document.getElementById('logoTitle').addEventListener('click', () => {
      searchInput.value = '';
      clearBtn.classList.add('hidden'); // Sembunyikan tombol clear

      // Kosongkan hasil pencarian dan detail
      resultsWrap.classList.add('hidden')
      detailWrap.classList.add('hidden'); // Sembunyikan detail
      detailTitle.textContent = '';
      detailBody.innerHTML = '';

      // Reset halaman ke halaman pertama
      currentPage = 1;

      // Kosongkan hasil filter
      FILTERED = [];

      // Pastikan hasil pencarian terlihat
      // resultsWrap.classList.remove('hidden');
      // resultsMeta.textContent = '';  // Reset pesan hasil pencarian
      // resultsList.innerHTML = '';  // Hapus konten hasil pencarian
      // renderResultsUI();  // Render ulang hasil pencarian jika ada

      // Reset URL query params ke kondisi awal
      const params = stateToParams({ q: '', page: 1 });
      replaceRoute(params);
      
    });

    // ===== Fetch Data =====
    async function fetchData() {
      try {
        const [faqRes, gloRes] = await Promise.all([ fetch('/faq'), fetch('/glossary') ]);
        if (!faqRes.ok || !gloRes.ok) throw new Error('API error');

        const faqRows = await faqRes.json();
        const gloRows = await gloRes.json();

        const faqs = (faqRows || []).map(r => ({
          id: r.id ?? r.ID ?? r.Id ?? null,
          title: r.title ?? r.question ?? '',
          content: r.content ?? r.answer ?? '',
          image_url: r.image_url || null,
          link_url:  r.link_url  || null,
          category: 'FAQ',
          type: 'faq'
        }));

        const glossary = (gloRows || []).map(r => ({
          id: r.id ?? r.ID ?? r.Id ?? null,
          title: r.title ?? r.term ?? '',
          content: r.content ?? r.definition ?? '',
          image_url: r.image_url || null,
          link_url:  r.link_url  || null,
          category: 'Glosarium',
          type: 'glossary'
        }));

        ITEMS = [...faqs, ...glossary].filter(x => x.id && x.title);
        ITEMS.sort((a,b) => a.title.localeCompare(b.title, 'id', { sensitivity: 'base' }));

        // kalau kosong
        if (!ITEMS.length) {
          resultsWrap.classList.remove('hidden');
          resultsMeta.textContent = '0 hasil';
          resultsList.innerHTML = '<div class="p-4 text-gray-500">Tidak ada data ditemukan.</div>';
        }
      } catch (e) {
        console.error('Gagal memuat data:', e);
        ITEMS = [];
        resultsWrap.classList.remove('hidden');
        resultsMeta.textContent = '';
        resultsList.innerHTML = '<div class="p-4 text-rose-600">Gagal memuat data. Coba muat ulang.</div>';
      }
    }


    function paginate(list, page, size) {
      const totalPages = Math.max(1, Math.ceil(list.length / size));
      const p = Math.min(Math.max(1, page), totalPages);
      const start = (p - 1) * size;
      const end = start + size;
      return { page: p, totalPages, slice: list.slice(start, end) };
    }

    function renderPaginationCompact(totalPages) {
      // ringkas: 1 … p-1 p p+1 … last
      paginationWrap.innerHTML = '';
      if (totalPages <= 1) { paginationWrap.classList.add('hidden'); return; }
      paginationWrap.classList.remove('hidden');

      const makeBtn = (label, {active=false, disabled=false, pageNum=null}={}) => {
        const btn = document.createElement('button');
        btn.textContent = label;
        btn.className =
          "px-3 py-1 rounded-lg border text-sm " +
          (active ? "bg-emerald-600 text-white border-emerald-600" : "hover:bg-gray-50") +
          (disabled ? " opacity-40 cursor-not-allowed" : "");
        if (!disabled && pageNum != null) {
          btn.addEventListener('click', () => { currentPage = pageNum; updateRouteAndUI(); });
        }
        paginationWrap.appendChild(btn);
      };
      const makeDots = () => {
        const span = document.createElement('span');
        span.textContent = '…';
        span.className = "px-2 text-gray-500";
        paginationWrap.appendChild(span);
      };

      // Prev
      makeBtn('‹', {disabled: currentPage===1, pageNum: currentPage-1});

      // numbers
      if (totalPages <= 7) {
        for (let i=1;i<=totalPages;i++){
          makeBtn(String(i), {active: i===currentPage, pageNum: i});
        }
      } else {
        makeBtn('1', {active: currentPage===1, pageNum: 1});
        if (currentPage > 3) makeDots();
        const start = Math.max(2, currentPage - 1);
        const end = Math.min(totalPages - 1, currentPage + 1);
        for (let p = start; p <= end; p++) makeBtn(String(p), {active: p===currentPage, pageNum: p});
        if (currentPage < totalPages - 2) makeDots();
        makeBtn(String(totalPages), {active: currentPage===totalPages, pageNum: totalPages});
      }

      // Next
      makeBtn('›', {disabled: currentPage===totalPages, pageNum: currentPage+1});
    }

    // Function untuk menampilkan hasil pencarian dan memeriksa apakah ada hasil
    function renderResultsUI() {
      const q = (searchInput.value || '').trim();
      const { page, totalPages, slice } = paginate(FILTERED, currentPage, PAGE_SIZE);
      currentPage = page; // clamp

      resultsWrap.classList.remove('hidden')


      resultsList.innerHTML = '';
      if (FILTERED.length === 0) {
        resultsMeta.textContent = '0 hasil';
        resultsList.innerHTML = '<div class="py-6 px-3 text-gray-500">Tidak ada hasil. Coba kata kunci lain.</div>';
        renderPaginationCompact(1);
        
        // Jika tidak ada hasil, sembunyikan detail
        detailWrap.classList.add('hidden');
        return;
      }

      resultsMeta.textContent = `${FILTERED.length} hasil – halaman ${currentPage} dari ${totalPages}`;

      slice.forEach((item) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <button class="w-full text-left p-3 hover:bg-gray-50 focus:bg-emerald-50 outline-none rounded-lg"
                  data-id="${item.id}" data-type="${item.type}" tabindex="-1">
            <div class="flex items-center gap-2">
              <span class="rounded-full border px-2 py-0.5 text-xs text-gray-600">${item.category}</span>
              <h3 class="font-medium">${highlight(item.title, q)}</h3>
            </div>
            <p class="mt-1 line-clamp-2 text-sm text-gray-600">
              ${highlight((item.content || '').slice(0, 160) + ((item.content||'').length>160 ? '…':''), q)}
            </p>
          </button>`;
        resultsList.appendChild(li);
      });

      renderPaginationCompact(totalPages);
      activeIndex = -1;
    }

    function renderDetail(item) {
      if (!item) {
        activeItem = null;
        // Jika tidak ada item, sembunyikan detail dan bersihkan kontennya
        detailWrap.classList.add('hidden');
        detailView.classList.add('hidden');
        detailTitle.textContent = '';
        detailBody.innerHTML = ''; // Kosongkan konten

        // Pastikan gambar juga disembunyikan jika tidak ada item
        detailImage.classList.add('hidden');
        detailImage.src = '';

        // Hapus tautan terkait jika tidak ada item
        detailLinksWrap.classList.add('hidden');
        detailLinks.innerHTML = '';

        return;
      }

      // Jika ada item, tampilkan detail
      detailWrap.classList.remove('hidden');
      activeItem = item;
      detailCat.textContent = item.category || '';
      detailTitle.textContent = item.title || '';
      detailBody.innerHTML = item.content || ''; // Menggunakan innerHTML agar HTML tags (seperti <img>) dimasukkan

      // Untuk gambar lainnya
      const imgUrl = normalizeImageUrl(item.image_url);
      if (imgUrl) {
        detailImage.src = imgUrl;
        detailImage.referrerPolicy = 'no-referrer';
        detailImage.classList.remove('hidden');
        detailImage.onerror = () => detailImage.classList.add('hidden');
      } else {
        detailImage.src = '';
        detailImage.classList.add('hidden');
      }

      // Tampilkan tautan terkait jika ada
      if (item.url_link) {
        detailLinksWrap.classList.remove('hidden');
        detailLinks.innerHTML = `
          <li>
            <a href="${item.url_link}" target="_blank" class="text-blue-600 hover:underline">Buka tautan terkait</a>
          </li>`;
      } else {
        detailLinksWrap.classList.add('hidden');
        detailLinks.innerHTML = '';
      }

      renderAdminState();
      detailEditForm.classList.add('hidden');
      detailView.classList.remove('hidden');
    }

    // Event listener untuk elemen daftar hasil pencarian (FAQ atau Glosarium)
    document.getElementById('resultsList').addEventListener('click', function (e) {
      const btn = e.target.closest('button[data-id]'); // Ambil elemen button di dalam list
      if (!btn) return;

      const id = btn.getAttribute('data-id');
      const type = btn.getAttribute('data-type');

      // Cari item berdasarkan ID dan tipe dari daftar yang sudah difilter
      const item = FILTERED.find(x => String(x.id) === String(id) && x.type === type)
                  || ITEMS.find(x => String(x.id) === String(id) && x.type === type);

      // Tampilkan detail item yang diklik
      renderDetail(item);
    });


    function showResultsUI() {
      resultsWrap.classList.remove('hidden');
      detailWrap.classList.remove('hidden');
    }

    function applyFilter() {
      const q = (searchInput.value || '').toLowerCase().trim();
      FILTERED = q ? ITEMS.filter(d => [d.title, d.content].some(t => t?.toLowerCase().includes(q))) : ITEMS.slice();
    }

    function updateRouteAndUI() {
      const params = stateToParams({ q: searchInput.value.trim(), page: currentPage, id: activeItem?.id, type: activeItem?.type });
      pushRoute(params);
      renderResultsUI();
      if (activeItem) renderDetail(activeItem);
    }

    // Function untuk mencari dan memastikan status ketika search kosong
    async function doSearch(e) {
      if (e) e.preventDefault();

      resultsWrap.classList.remove('hidden');

      // Jika input pencarian kosong, sembunyikan detail dan jangan lakukan pencarian
      if (searchInput.value.trim() === '') {
        detailWrap.classList.add('hidden');  // Sembunyikan detail
        return;  // Menghentikan fungsi jika tidak ada input pencarian
      }

      if (!ITEMS.length) await fetchData();  // Ambil data jika belum ada

      clearBtn.classList.toggle('hidden', !(searchInput.value || '').length);
      applyFilter();
      currentPage = 1; // Reset ke halaman 1 setiap pencarian baru

      if (!searched) { searched = true; showResultsUI(); }

      renderResultsUI();
      renderDetail(FILTERED[0] || null);

      // Sync URL
      const params = stateToParams({ q: searchInput.value.trim(), page: currentPage, id: activeItem?.id, type: activeItem?.type });
      replaceRoute(params);

      // Jika hasil pencarian kosong, sembunyikan detail
      if (FILTERED.length === 0) {
        detailWrap.classList.add('hidden');
      }
    }


    function handleSearchResult(results) {
      if (results.length === 0) {
        renderDetail(null); // Kosongkan tampilan detail
        // Mungkin juga tampilkan pesan "Tidak ditemukan"
        return;
      }

      // Jika ada hasil, tampilkan yang pertama misalnya
      renderDetail(results[0]);
    }



    function applyAsideLayout() {
      const aside = document.getElementById('rightAside');
      const middle = document.getElementById('middleCol');
      const left = document.getElementById('leftCol');

      // ketika aside disembunyikan → tengah melebar (4 → 8)
      if (aside.classList.contains('hidden')) {
        left.classList.remove('md:col-span-3')
        left.classList.add('md:col-span-4');
        middle.classList.remove('md:col-span-5');
        middle.classList.add('md:col-span-8');
      } else {
        // ketika aside tampil → tengah kembali 4
        left.classList.remove('md:col-span-4')
        left.classList.add('md:col-span-3');
        middle.classList.remove('md:col-span-8');
        middle.classList.add('md:col-span-5');
      }
    }

    function toggleAside() {
      const aside = document.getElementById("rightAside");
      aside.classList.toggle("hidden");
      applyAsideLayout(); 
    }

    // ✅ NEW: show/hide panel Admin Bar
    function toggleAdminBar(force) {
      const el = document.getElementById('adminBar');
      if (!el) return;
      if (typeof force === 'boolean') {
        el.classList.toggle('hidden', !force);
      } else {
        el.classList.toggle('hidden');
      }
    }



    // ===== Events =====
    searchForm.addEventListener('submit', doSearch);
    searchInput.addEventListener('input', (e) => {
      clearBtn.classList.toggle('hidden', !e.target.value.length);
      if (searched) { applyFilter(); currentPage = 1; renderResultsUI(); renderDetail(FILTERED[0] || null); }
    });
    clearBtn.addEventListener('click', () => {
      searchInput.value = '';
      clearBtn.classList.add('hidden');
      if (searched) { applyFilter(); currentPage = 1; renderResultsUI(); renderDetail(FILTERED[0] || null); }
    });

    resultsList.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-id]');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const type = btn.getAttribute('data-type');
      const item = FILTERED.find(x => String(x.id) === String(id) && x.type === type)
                    || ITEMS.find(x => String(x.id) === String(id) && x.type === type);
      renderDetail(item);
      const params = stateToParams({ q: searchInput.value.trim(), page: currentPage, id: item.id, type: item.type });
      pushRoute(params);
    });

    // Keyboard navigation untuk list: Up/Down + Enter
    resultsList.addEventListener('keydown', (e) => {
      const buttons = Array.from(resultsList.querySelectorAll('button[data-id]'));
      if (!buttons.length) return;
      if (['ArrowDown','ArrowUp','Enter'].includes(e.key)) e.preventDefault();
      if (e.key === 'ArrowDown') {
        activeIndex = Math.min(buttons.length-1, activeIndex + 1);
        buttons[activeIndex].focus();
      } else if (e.key === 'ArrowUp') {
        activeIndex = Math.max(0, activeIndex - 1);
        buttons[activeIndex].focus();
      } else if (e.key === 'Enter' && activeIndex >= 0) {
        buttons[activeIndex].click();
      }
    });

    // ===== Admin: Tambah FAQ / Glosarium =====
    document.getElementById('faqAddBtn')?.addEventListener('click', async () => {
      const title = (document.getElementById('faqTitle').value || '').trim();
      const content = (document.getElementById('faqContent').value || '').trim();
      const image_url = (document.getElementById('faqImageUrl').value || '').trim();
      const link_url  = (document.getElementById('faqUrlLink').value || '').trim();
      if (!title || !content) return alert('Isi pertanyaan & jawaban');

      try {
        const res = await fetch('/faq', {
          method:'POST',
          headers: headersJSON(),
          body: JSON.stringify({ title, content, image_url, link_url })
        });
        if (!res.ok) throw new Error((await res.json()).error || 'Gagal menambah FAQ');

        // reset form
        document.getElementById('faqTitle').value = '';
        document.getElementById('faqContent').value = '';
        document.getElementById('faqImageUrl').value = '';
        document.getElementById('faqUrlLink').value  = '';
        await doSearch();
      } catch (e) { alert(e.message); }
    });



    document.getElementById('gloAddBtn')?.addEventListener('click', async () => {
      const title = (document.getElementById('gloTitle').value || '').trim();
      const content = (document.getElementById('gloContent').value || '').trim();
      const image_url = (document.getElementById('gloImageUrl').value || '').trim();
      const link_url  = (document.getElementById('gloUrlLink').value || '').trim();
      if (!title || !content) return alert('Isi istilah & definisi');
      try {
        const res = await fetch('/glossary', {
          method:'POST',
          headers: headersJSON(),
          body: JSON.stringify({ title, content, image_url, link_url })
        });
        if (!res.ok) throw new Error((await res.json()).error || 'Gagal menambah glosarium');
        document.getElementById('gloTitle').value = '';
        document.getElementById('gloContent').value = '';
        document.getElementById('gloImageUrl').value = '';
        document.getElementById('gloUrlLink').value = '';
        await doSearch();
      } catch (e) { alert(e.message); }
    });


    // ===== Admin: Edit/Hapus di panel detail (INLINE) =====
    detailEditBtn.addEventListener('click', () => {
      if (!activeItem) return;
      editTitle.value = activeItem.title || '';
      editContent.value = activeItem.content || '';
      editImageUrl.value = activeItem.image_url || '';
      document.getElementById('editUrlLink').value = activeItem.link_url || ''; // ← isi url link
      detailView.classList.add('hidden');
      detailEditForm.classList.remove('hidden');
    });

    detailCancelBtn.addEventListener('click', () => {
      detailEditForm.classList.add('hidden');
      detailView.classList.remove('hidden');
    });

    detailEditForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!activeItem) return;

      const newTitle = editTitle.value.trim();
      const newContent = editContent.value.trim();
      const newImage = (editImageUrl.value || '').trim();
      const newUrl   = (document.getElementById('editUrlLink').value || '').trim();

      if (!newTitle || !newContent) return alert('Judul & Konten wajib diisi');

      try {
        const url = `/${activeItem.type}/${activeItem.id}`;
        const res = await fetch(url, {
          method:'PUT',
          headers: headersJSON(),
          body: JSON.stringify({ title: newTitle, content: newContent, image_url: newImage, link_url: newUrl })
        });
        if (!res.ok) throw new Error((await res.json()).error || 'Gagal menyimpan perubahan');

        await doSearch();
        detailEditForm.classList.add('hidden');
        detailView.classList.remove('hidden');
      } catch (e) { alert(e.message); }
    });

    detailDeleteBtn.addEventListener('click', async () => {
      if (!activeItem) return;
      if (!confirm('Yakin hapus entri ini?')) return;
      try {
        const url = `/${activeItem.type}/${activeItem.id}`;
        const res = await fetch(url, { method:'DELETE', headers: headersJSON() });
        if (!res.ok) throw new Error((await res.json()).error || 'Gagal menghapus');
        activeItem = null;
        await doSearch();
        if (!FILTERED.length) {
          detailTitle.textContent = '';
          detailBody.textContent = '';
          detailCat.textContent = '';
        }
      } catch (e) { alert(e.message); }
    });

    function toggleLiveAssistant() {
      const box = document.getElementById("liveAssistantBox");
      box.classList.toggle("hidden");
    }

    function sendToEmail() {
      const subject = document.getElementById("assistantSubject").value.trim();
      const message = document.getElementById("assistantMsg").value.trim();

      if (!subject && !message) {
        alert("Isi subjek atau pesan terlebih dahulu.");
        return;
      }

      const email = "rashadfajar@gmail.com"; // ganti dengan alamat email tujuan
      const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
      window.location.href = mailtoLink;
    }


    // ===== Salin tautan detail =====
    copyLinkBtn?.addEventListener('click', async () => {
      if (!activeItem) return;
      const params = stateToParams({ q: searchInput.value.trim(), page: currentPage, id: activeItem.id, type: activeItem.type });
      const url = `${location.origin}${location.pathname}?${params}`;
      try {
        await navigator.clipboard.writeText(url);
        copyLinkStatus.classList.remove('hidden');
        setTimeout(()=>copyLinkStatus.classList.add('hidden'), 1200);
      } catch (e){ alert(url); }
    });

    // ===== Router: back/forward & boot from URL =====
    window.addEventListener('popstate', async () => {
      const { q, page, id, type } = readRoute();
      if (!ITEMS.length) await fetchData();
      searchInput.value = q || '';
      clearBtn.classList.toggle('hidden', !q);
      applyFilter();
      currentPage = page || 1;
      showResultsUI();
      renderResultsUI();
      if (id && type){
        const item = FILTERED.find(x=>String(x.id)===String(id) && x.type===type) || ITEMS.find(x=>String(x.id)===String(id) && x.type===type);
        if (item) renderDetail(item);
      } else {
        renderDetail(FILTERED[0] || null);
      }
    });

    // Boot: baca URL params kalau ada
    (async function boot(){
      const { q, page, id, type } = readRoute();
      if (!ITEMS.length) await fetchData();
      if (q){ searchInput.value = q; clearBtn.classList.remove('hidden'); searched = true; showResultsUI(); applyFilter(); currentPage = page || 1; renderResultsUI(); }
      if (id && type){
        const item = ITEMS.find(x=>String(x.id)===String(id) && x.type===type);
        if (item){ renderDetail(item); }
      } else if (q){
        renderDetail(FILTERED[0] || null);
      }
      if (q || id){ replaceRoute(stateToParams({ q: searchInput.value.trim(), page: currentPage, id, type })); }
      renderAdminState();
    })();
    applyAsideLayout();      
  </script>
</body>
</html>
